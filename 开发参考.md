下面给你一套**可落地的“本格少年侦探故事”生成工作流**，覆盖：整体架构 → 数据与接口规范（JSON Schema）→ 管线/状态机 → 关键算法与校验 → LLM 提示词模板（不泄漏思维链，仅产出结构化结果）→ 质量与安全 → 前端阅读/互动设计。你可以按此直接落地为一个故事 App（本地或云端均可）。

---

## 0) 目标与原则

* **目标**：可重复、可控地产出“蛋蛋”系列长篇侦探故事；保证**公平线索**、**工程可行的诡计**、**少儿友好**、**风格统一**。
* **核心原则**

  1. **两阶段生成**：先出**蓝图**（结构化 JSON），再据蓝图逐章写作；
  2. **四类校验**：线索公平性、时间轴一致性、诡计可行性、语言与年龄适配；
  3. **严格格式**：LLM 输出强制 JSON（拒绝长段解释），方便机器验收与再加工。

---

## 1) 系统架构（模块与职责）

```
StoryApp
├── orchestrator/               # 管线编排器（状态机）
├── engines/
│   ├── planner_llm/            # “蓝图”规划引擎（LLM）
│   ├── writer_llm/             # 章节写作引擎（LLM）
│   ├── editor_llm/             # 风格/阅读级别编辑引擎（LLM）
│   └── fact_checker/           # 一致性/公平性/可行性校验（规则+小模型）
├── domain/
│   ├── trope_library.json      # 诡计/套路库（中心奇迹、误导清单等）
│   ├── style_guides.json       # 语气、年龄分级、禁用词
│   └── locale/…                # 多语言资源
├── storage/
│   ├── projects/               # 每个故事项目（蓝图、草稿、最终稿）
│   └── exports/                # ePub/HTML/内嵌互动包
├── frontend/
│   ├── reader                  # 阅读器（章节/证物/时间线视图）
│   └── builder                 # 父母/作者端（参数面板、可视化线索矩阵）
└── services/
    ├── compile_exporter        # ePub/HTML/互动 JSON 打包
    └── moderation              # 内容安全与家长控制
```

---

## 2) 数据模型（JSON Schema 摘要）

> 约定：所有 ID 用 `ulid`/`uuid`；时间字段使用“相对幕内时刻”或 ISO8601。

### 2.1 故事项目 `StoryProject`

```json
{
  "project_id": "ulid",
  "title": "string",
  "locale": "zh-CN",
  "protagonist": { "name": "蛋蛋", "age": 12 },
  "constraints": {
    "reading_level": "middle_grade", 
    "max_words": 12000,
    "violence_rating": "low",
    "mystery_rigor": "high"
  },
  "blueprint_id": "ulid",
  "draft_id": "ulid",
  "status": "INIT|BLUEPRINT_READY|DRAFT_READY|FINAL_READY"
}
```

### 2.2 蓝图 `StoryBlueprint`

```json
{
  "blueprint_id": "ulid",
  "logline": "一句话梗概",
  "theme": ["风之匙","光之锁","成长"],
  "setting": { "stage": "孤岛古堡", "era": "当代", "weather": "暴风雨" },
  "central_device": {           // 中心奇迹（诡计核）
    "type": "远程机关·潮汐/风驱动",
    "science_hooks": ["共振","滑轮传动","潮汐表"],
    "impossible_claim": "密室敲钟与门闩内插"
  },
  "cast": [
    {"id":"c1","name":"郇夫人","role":"antagonist-planner","motive":"守护航记"},
    {"id":"c2","name":"沈伯","role":"accomplice","motive":"忠诚"},
    {"id":"c3","name":"陆清","role":"red-herring","motive":"学术占有"},
    {"id":"c4","name":"周老","role":"foil","motive":"护花"},
    {"id":"c5","name":"方庆","role":"victim","motive":"敲诈"}
  ],
  "locations": [
    {"id":"L1","name":"钟楼","kind":"vertical"},
    {"id":"L2","name":"大厅","kind":"hub"},
    {"id":"L3","name":"温室","kind":"utility"},
    {"id":"L4","name":"风道/管网","kind":"hidden"},
    {"id":"L5","name":"彩窗暗道","kind":"secret"}
  ],
  "clues": [
    {"id":"K1","name":"第七钟后细响","category":"acoustic","truth":"手杖簧片共振","appears_in":["S1","S8"]},
    {"id":"K2","name":"门缝铜丝","category":"mechanical","truth":"远程传动","appears_in":["S3","S6"]},
    {"id":"K3","name":"盐霜‘遗言’","category":"forensic","truth":"揭字非临写","appears_in":["S4","S9"]},
    {"id":"K4","name":"潮汐表","category":"temporal","truth":"触发时刻","appears_in":["S5"]},
    {"id":"K5","name":"彩窗‘海鸥眼’","category":"architecture","truth":"窥视孔","appears_in":["S2","S7"]}
  ],
  "timeline": [
    {"t":"19:00","event":"七声钟+细响","loc":"L2"},
    {"t":"22:30","event":"远程机关首次轻击","loc":"L1"},
    {"t":"22:40","event":"受害者倒地","loc":"L1"},
    {"t":"02:00","event":"温室起火","loc":"L3"}
  ],
  "acts": [
    {
      "act_no":1,"goal":"设谜",
      "beats":[
        {"scene_id":"S1","type":"hook","purpose":"第八声传闻"},
        {"scene_id":"S2","type":"explore","purpose":"彩窗与家徽"}
      ]
    },
    {
      "act_no":2,"goal":"调查",
      "beats":[
        {"scene_id":"S3","type":"crime_scene","purpose":"密室与铜丝"},
        {"scene_id":"S4","type":"forensic","purpose":"盐霜揭字实验"},
        {"scene_id":"S5","type":"system","purpose":"风道/潮汐路径"},
        {"scene_id":"S6","type":"setback","purpose":"温室失火转移视线"},
        {"scene_id":"S7","type":"discovery","purpose":"暗道与窥视"}
      ]
    },
    {
      "act_no":3,"goal":"揭晓",
      "beats":[
        {"scene_id":"S8","type":"tableau","purpose":"餐桌复盘"},
        {"scene_id":"S9","type":"resolution","purpose":"开匣与善后"}
      ]
    }
  ],
  "fairness_policy": {
    "min_exposures_per_key_clue": 2,
    "must_show_before_reveal": ["K1","K2","K3","K5"],
    "violent_ceiling":"low"
  }
}
```

### 2.3 章节草稿 `StoryDraft`

```json
{
  "draft_id":"ulid",
  "blueprint_id":"ulid",
  "chapters":[
    {"scene_id":"S1","title":"序章·雾岚与古堡","words":1800,"text":"..."},
    {"scene_id":"S2","title":"海鸥的眼睛","words":1500,"text":"..."}
  ],
  "quality_report":{"fairness_ok":true,"consistency_ok":true,"reading_level":"middle_grade"}
}
```

---

## 3) 整体工作流（状态机）

```
INIT
 └─► PLAN_BLUEPRINT
       ├─ 调用 Planner（输出严格 JSON 蓝图）
       ├─ 校验(1)：Schema/线索覆盖/时间轴冲突
       └─► OUTLINE_READY
             └─► WRITE_DRAFT
                   ├─ 按 scene_id 逐章写作（引用蓝图字段）
                   ├─ 校验(2)：一致性/公平性/语料风险
                   ├─ 若失败 → 回滚到 PLAN 修正（只改蓝图受影响处）
                   └─► DRAFT_READY
                         └─► EDIT_AND_STYLE
                               ├─ 语气/年龄分级打磨
                               ├─ 章节衔接/节奏压缩
                               └─► FINAL_READY
                                     └─► EXPORT (ePub/HTML+互动JSON)
```

---

## 4) 关键校验（算法/规则）

### 4.1 公平线索覆盖

* 规则：`min_exposures_per_key_clue ≥ 2`；所有 `must_show_before_reveal` 在 `S8`（复盘）之前至少出现一次。
* 伪代码：

```python
def check_fairness(blueprint, draft):
    exposure = {k['id']:0 for k in blueprint['clues']}
    for ch in draft['chapters']:
        for k in blueprint['clues']:
            if k['id'] in get_clue_mentions(ch['text'], k):
                exposure[k['id']] += 1
    ok1 = all(exposure[k] >= blueprint['fairness_policy']['min_exposures_per_key_clue']
              for k in exposure)
    # reveal前出现
    reveal_index = index_of_scene(draft, "S8")
    ok2 = all(first_mention_index(draft, clue_id) < reveal_index 
              for clue_id in blueprint['fairness_policy']['must_show_before_reveal'])
    return ok1 and ok2, exposure
```

> `get_clue_mentions` 可用关键词+embedding 双检，避免漏报。

### 4.2 时间轴一致性

* 规则：`timeline` 事件按时序递增；章节中显式时间戳与蓝图不冲突；潮汐/昼夜等自然条件与设定吻合。

```python
def check_timeline(blueprint, draft):
    if not is_sorted(blueprint['timeline'], key="t"): return False
    # 从文本提取时间点（正则+LLM 小调用结构化抽取）
    extracted = extract_times_from_text(draft)
    return compare(extracted, blueprint['timeline'])
```

### 4.3 诡计可行性（轻量）

* 对中心传动链给出**最小必要条件**：摩擦系数<阈值、转角数≤N、触发源=潮汐/风；若文本宣称“自动精准击倒”，判为风险（提示改为“惊吓/失足”等）。

```python
def check_device_feasibility(device):
    return (device['type'].startswith("远程机关")
            and "滑轮" in " ".join(device['science_hooks']))
```

### 4.4 年龄与语言安全

* 词表扫描 + 句长/词频统计 + 语义风险（脏话、恐怖强度）。不合规→回写 `editor_llm` 降级处理。

---

## 5) Orchestrator 伪代码（Python 风格）

```python
def run_project(config):
    bp = plan_blueprint(config)                 # LLM: Planner
    assert validate_blueprint(bp)

    draft = []
    for beat in iter_beats(bp):
        ch = write_scene(bp, beat)             # LLM: Writer（只写该 scene）
        ch = edit_style(ch, config)            # LLM: Editor（阅读级别、语气）
        draft.append(ch)

    report = run_quality_checks(bp, draft)     # 4类校验
    if not report["all_ok"]:
        bp = minimal_fix_blueprint(bp, report) # 仅修问题处
        return run_project(config.with_blueprint(bp))

    book = compile_export(bp, draft, format="epub+interactive")
    return book, report
```

---

## 6) 关键资源：套路/诡计库（可扩展 JSON）

```json
[
  {
    "id":"device_remote_tide_wind",
    "name":"潮汐/风驱动远程机关",
    "requires":["风道/管网","滑轮","细金属丝","触发表(潮汐/风)"],
    "misdirection":["超自然怪音","密室内遗言","家徽意象"],
    "fairness_hooks":["嗅觉(藻腥/金属)","触感(油渍)","听觉(拍频)"]
  },
  {
    "id":"resonance_cane_spring",
    "name":"簧片共振‘第八声’",
    "requires":["可共振腔体(手杖/盒)","音高差"],
    "misdirection":["闹钟诅咒传闻"],
    "fairness_hooks":["多次近距离听音","实验重现"]
  }
]
```

---

## 7) LLM 提示词模板（**只产出结构化结果**）

> 约定：在 system 指令中声明“只输出 JSON，禁止解释”。以下给出 3 个关键模板。

### 7.1 规划器（Planner）

**输入**：`StoryProject.constraints + 偏好 + trope_library 片段`
**输出**：`StoryBlueprint`（上面 Schema）

```
# system
你是剧情规划器。请在内部推理后，仅输出符合下述 JSON Schema 的对象。禁止输出除 JSON 之外的任何内容。
Schema: <粘贴 StoryBlueprint Schema 摘要字段说明>。

# user
请基于以下约束生成“蛋蛋”系列侦探故事蓝图：
- 舞台：古堡/孤岛
- 中心奇迹：潮汐+风道远程机关 + 共振怪音
- 阅读级别：middle_grade
- 暴力级别：low
- 字数目标：10-12k

附：可用诡计库片段（JSON）：
<trope_library 片段>
```

### 7.2 写作器（Writer）

**输入**：`StoryBlueprint + scene_id`
**输出**：`{scene_id,title,words,text}`

```
# system
你是儿童向长篇小说写作引擎。只输出指定 JSON 字段。语言自然、避免过度恐怖、避免紫色辞藻。

# user
请根据蓝图为 scene_id=S3 写章节草稿。
风格：第一人称（蛋蛋），感官细节优先；字数 1500±15%。
必须包含但不剧透：clues 中标记出现在 S3 的要素。
输出：
{"scene_id":"S3","title":"string","words":1234,"text":"..."}
```

### 7.3 编辑器（Editor）

**输入**：章节 JSON + 语言/年龄规则
**输出**：同结构 JSON（仅 text 改写）

```
# system
你是分级编辑器。保持剧情不变，控制句长、词频，删除不当用词。只返回同结构 JSON。

# user
阅读级别 middle_grade；去除可能引发噩梦的描写（血腥/细节化暴力）。
```

---

## 8) 互动阅读与“破案模式”数据

为读者提供**侦探工具视图**（无需额外生成，只从蓝图衍生）：

```json
{
  "interactive_pack": {
    "cast_cards": [{ "id":"c1","bio":"..." }],
    "clue_matrix": [
      {"clue_id":"K1","scenes":["S1","S8"],"status":"shown"},
      {"clue_id":"K2","scenes":["S3","S6"],"status":"shown"}
    ],
    "timeline_view": [{"t":"19:00","event":"七声钟"}],
    "quiz": [
      {
        "id":"Q1",
        "question":"第八声的最合理来源？",
        "options":["超自然","共振簧片","风碰窗","老管道"],
        "answer":"共振簧片",
        "explain_scene":"S8"
      }
    ]
  }
}
```

---

## 9) 前端 UX（家长端 + 小读者端）

* **家长/作者端（Builder）**

  * 参数面板：舞台、中心奇迹、阅读级别、篇幅、复杂度；
  * 一键生成蓝图 → 可视化**线索矩阵**与**时间线** → 不满意点对点重生（局部刷新）。
* **阅读端（Reader）**

  * 章节阅读 + 右滑打开“证物板”（人物/线索/时间线）；
  * “破案模式”在第 2 幕后开放 3 道选择题；
  * 结尾自动展示“公平线索回收表”。

---

## 10) 质量与安全（家长可控）

* **敏感度**：词典+正则+embedding 三重检测（暴力、恐怖、低俗）。
* **难度档**：控制句子平均长度（例如 ≤ 22 字）、高频字覆盖率≥90%。
* **随机性控制**：`seed` 固定→可重现；`temperature` 分层（规划低/写作中/编辑低）。

---

## 11) 最小可用实现（MVP 行动清单）

1. **落库**：把上面的 Schema 存成 TypeScript 接口 / Pydantic 模型。
2. **诡计库**：先录入 5 个常用中心奇迹 + 对应公平钩子。
3. **三引擎**：用同一个大模型分三条 system 设定（Planner/Writer/Editor）。
4. **校验器**：先实现 4.1/4.2 的基础版（关键词+正则+简单图检）。
5. **导出器**：HTML + 互动 JSON；ePub 可用现成库（如 Python `ebooklib` 或 Node `epub-gen`）。
6. **前端**：阅读器先做章节+证物侧栏；家长端先做参数表单+蓝图可视化（时间线/矩阵）。

---

## 12) 示例：一次端到端调用顺序（伪 API）

```
POST /api/projects -> {project_id}
POST /api/plan -> {project_id}  # 调 Planner，落地 blueprint
GET  /api/blueprint/:id -> StoryBlueprint
POST /api/write -> {project_id, scene_id}  # 逐章
POST /api/edit  -> {project_id, scene_id}
POST /api/check -> {project_id} -> {report}
POST /api/compile -> {project_id, format:"html+interactive"} -> download_url
```

---

## 13) 可扩展方向

* **多案并行**：把“中心奇迹”做成插件（比如“时间错位不在场证明”“镜像迷宫”“双重行凶路径”）。
* **自选分支**：在第二幕插入 1~2 个支线场景，让小读者选择调查对象（同蓝图下生成两个 scene 变体）。
* **音频化**：导出“角色卡片+台词”→ TTS；音效库加入“风/海/钟”。

---

### 结语

上面的结构把“**工程化本格推理**”拆成：**蓝图—写作—校验—编辑—导出**五段链路，并用**强 Schema + 规则校验**保证故事的“可复用/可控/可复盘”。只要你按此搭建，一个按钮就能稳定批量产出“蛋蛋”系列的长篇——既有推理的严谨，也有少年阅读的轻快。

如果你需要，我可以把**Planner/Writer/Editor 的可直接粘贴使用的完整提示词与 JSON Schema**打包成三个独立文件（`planner_prompt.txt` / `writer_prompt.txt` / `editor_prompt.txt`）和一份最小示例蓝图种子，便于你直接集成到后端。
