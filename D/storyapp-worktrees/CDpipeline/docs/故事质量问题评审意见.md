# 故事质量问题评审意见

## 代码定位与现状

- 生成单段故事：`backend/src/services/storyService.ts` 的 `generateStoryService(...)`
  - 首次/续写通过 `STORY_SYSTEM_PROMPT` 与 `STORY_CONTINUE_PROMPT` 调用 `DEEPSEEK_CONFIG.CHAT_MODEL`。
  - 解析 JSON（失败则回退为截断文本+默认 choices），强制 choices 为最多 3 个；`forceEnding` 时清空 choices 并标记 `isEnding`。
  - 段落字数 < 500 时，二次调用 Chat 做“扩写润色”保证 ≥ 500 字。
- 故事树（增强版，三阶段）：`generateFullStoryTreeService(...) → generateAdvancedStoryTree(...)`
  - Phase 1 规划：`callDeepSeekReasoner(...)` 用 `REASONER_MODEL` + `STORY_PLANNING_PROMPT` 产出完整大纲。
  - Phase 2 写作：`callDeepSeekChat(...)` 用 `STORY_WRITING_PROMPT` 逐段落生成开头/分支/结局（每段 ≥ 500 字）。
  - Phase 3 质检：`reviewAndRefineNodes(...)` 用 `REASONER_MODEL` + `STORY_REVIEW_PROMPT` 审核每段，未通过则用 Chat 结合建议“定向改写”，再纳入最终树。
- 节点逐个生成（基础版兼容）：`generateStoryTreeNode(...)`
  - 统一 ≥ 500 字，不足时同样扩写；叶子节点强制 `choices=[]/isEnding=true`；中间节点强制 2 个 choices。
- DeepSeek 客户端与提示词：`backend/src/config/deepseek.ts`
  - Axios 客户端含超时(180s)、3 次指数退避重试(网络错误/502–504)、模型名常量、系统/连续/树/复审提示词。
- 健康检查与限流：`backend/src/routes/health.ts`（DB ping 与 DeepSeek Key 存在性）；`backend/src/index.ts` 用 `express-rate-limit` 全局限流、`helmet`/CORS、JSON Body 限制。
- 数据与校验：Mongo 初始化索引（`created_at` 倒序、`title` 文本索引）；保存前基本校验（标题非空/≤200，内容非空）。

## 已存在的“质量保证”机制要点

- 基于 Reason 模型的两处质控：
  - 规划前置（结构先行）：Reasoner 产出大纲，降低随意性与跑题。
  - 内容复核（逐段审稿）：Reasoner 打分与建议，未达标再让 Chat 定向改写。
- 结构与格式强约束：
  - 所有接口统一 JSON 格式；choices 数量约束；强制结尾时覆盖 AI 响应。
- 字数与风格兜底：
  - <500 字二次扩写；系统提示词明确儿童友好与避雷项。
- 弹性容错与可用性：
  - DeepSeek 请求自动重试；API Key 缺失走“模拟数据”；增加请求超时。
- 安全与稳态：
  - 全局限流、Helmet、CORS；DB 索引；健康检查。

## 我建议的质量与体验提升（深入思考版）

### 模型与提示词层

- 双向一致性校验器：在 Reason 审核里新增“剧情一致性检查”要点（角色、设定、时间线、口吻），输出不一致项并驱动定向改写。
- 年龄分级写作策略：在提示词加入目标年龄段（3–4/5–6/7–8），控制句长、词汇等级与段落复杂度。
- 价值观目标标注：在大纲阶段输出每条路径的“核心价值”（勇气/友爱/分享等），写作与复核阶段都对齐该标签。
- 选项质量标准：为 choices 增加“差异性、可操作性、情节驱动性、非冗余性”评分门槛，低分触发重写 choices。
- 语言检查器：增加“中文专用校对/润色”一步（规范标点、口语改书面、重复消解、病句修复）。
- JSON Schema 校验：用 `ajv/zod` 对模型输出做严格 Schema 校验（字段存在、数组长度、字符串最大最小长度、类型），避免解析随机性。
- 失败恢复策略：当解析失败时，不是直接 fallback，而是发“仅输出 JSON”纠错请求 1–2 次，再失败才降级。
- 长度与节奏控制：按段落类型分别设置长度范围（开头 600–800，中段 500–700，结局 600–900）与“睡前渐停（wind-down）”风格控制。

### 安全与合规

- 儿童安全审核器（多策略）：在 Reason 审核中加入敏感主题/恐怖场景/成人暗示/歧视性用语检测，必要时强制重写。
- 词表过滤与词形变体：维护敏感词表（武器、惊悚、成人内容），正则+LLM 双层过滤；对边界词用 Reasoner“语境鉴定”避免误杀。
- 主题白名单/黑名单：对用户 `topic` 做白名单优先+黑名单拦截；黑名单则引导到相近安全主题。
- PII 保护：禁止生成或保存任何个人敏感信息（名字、住址、联系方式等），加正则与 LLM 审核。

### 结构一致性与剧情记忆

- 事实表/角色卡：维护“故事状态对象”（角色名、关系、设定、目标、已发生事件），续写/复审前注入，防止人物属性漂移或设定遗失。
- 重复惩罚：统计 n-gram 重复与句式重复，超过阈值触发“同义改写”。
- 人称/时态一致（中文口吻）：约束第一/三人称全局一致，避免“他/她/它/他们”混乱；肢体/心理描写保持统一语气。
- 选项-片段因果闭环：在续写时强制引用“刚才选择”的动作词，确保因果承接而非重启剧情。
- 分支区分度：检测相邻分支的句向量相似度（阈值如 cosine>0.85 则认为相近），过近则重写其一提高差异性。

### 个性化与教育性

- 家长参数：父母可选择“教育主题”（勇敢/分享/环保/合作）与“风格”（童真/科普/诗意），纳入规划与复核打分。
- 儿童画像：输入孩子姓名/喜好（动物/太空/音乐），提示词里做轻个性化（仅文本，不存储 PII）。
- 难度自适应：根据阅读时长、停留/选择数据，逐步减少新词密度、增加重复线索，做“睡前降噪”。
- 词汇解释：在困难词边生成鼠标悬停/括注（可配开关），便于家长讲解。
- 结尾祝福模板：结尾统一加柔和“入睡节奏”，并附与价值观呼应的一句话总结。

### 前端体验与可访问性

- 流式生成/打字机效果：后端启用 `stream: true` + SSE，将生成过程实时反馈，缩短体感等待。
- 撤销/回退选择：支持回退上一步、分支地图可视化（节点图），提高探索体验。
- TTS 真正落地：接入科大讯飞/阿里云/百度 TTS，统一断句规则（中文标点+停顿），提供多音色与语速选择。
- 无障碍强化：更大可点击区、焦点样式、ARIA 标签、键盘完全可操作；朗读“当前段落/当前选项”。
- 离线/降级：DeepSeek 不可用时，使用高质量本地“模板库”与“精选故事”，保证基本可用。
- PDF/打印/分享：一键排版导出 PDF（大字/行距/插图占位），便于亲子共读；生成可分享链接（隐藏敏感参数）。

### 数据与可观测性

- 审核数据入库：保存 Reason 质量分、问题列表、改写次数、生成耗时，做后续分析与门槛策略迭代。
- 指标与告警：Prometheus/OTel 采集（成功率、95p 延时、超时率、重试率、流式中断率），SLA/SLO 预警。
- 成本策略：热点主题/重复输入缓存命中；分层模型（轻量模型→不通过再上 Reasoner）。
- 并发治理：为生成路由加队列与并发上限，避免突发压垮；请求级超时与取消（AbortController）。

### 工程与接口层（可快速落地）

- 统一 JSON 解析：`generateStoryService` 也改用已实现的 `extractJson(...)`，并加 `ajv` Schema 校验。
- 路由级限流：对 `/generate-story`、`/generate-full-story` 单独配置更严格的 `rateLimit` 策略（窗口/用户/IP 维度）。
- 审核开关：`GenerateStoryRequest` 增加可选 `audit: boolean`，对单段生成也走 Reason 审核与定向改写，默认开启。
- 选项规范器：确保 choices 唯一、长度 6–14 字、使用动词起句（不含疑问/否定）；超规即改写。
- 错误恢复：解析失败先发一次“仅输出 JSON，无注释/Markdown”的纠错请求；再失败才 fallback。

## 快速落地建议（优先级）

- 在 `generateStoryService` 接入 `extractJson + Schema 校验 + Reason 复核`，与树的流程一致化。
- 新增“主题白/黑名单 + 敏感词 LLM 复核”中间件，阻断危险输入与输出（含定向改写）。
- 启用 SSE 流式输出，显著提升生成等待体验。
- 接入 TTS（优先一个供应商），打通朗读路径；完善断句/标点处理。
- 记录并回传 `quality_score` 与 `issues/suggestions`，在前端以“家长提示”形式可视化。

（如需，我可按以上优先级给出具体代码变更示例：Schema 定义、服务层复用、SSE 接口与前端订阅、路由限流与中间件等，并补上 Jest 单测与一两个 Playwright 用例验证“质检未通过→改写→通过”的链路。）

