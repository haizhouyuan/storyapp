name: Codex Review

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

concurrency:
  group: codex-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codex:
    name: Codex automated review
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    permissions:
      contents: read
      pull-requests: write
      issues: write
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Codex review (powered by Claude)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          track_progress: true
          prompt: |
            è¯·ä»¥â€œè‡ªåŠ¨åŒ–è¯„å®¡åŠ©æ‰‹ï¼ˆCodexï¼‰â€èº«ä»½å®¡æŸ¥æ­¤PRï¼Œç›´è¾¾è¦ç‚¹ï¼š

            - ä»£ç è´¨é‡ä¸å¯ç»´æŠ¤æ€§ï¼ˆTypeScriptç±»å‹è¾¹ç•Œã€æ¨¡å—èŒè´£ã€é”™è¯¯å¤„ç†ï¼‰
            - å®‰å…¨æ€§ï¼ˆè¾“å…¥æ ¡éªŒã€Secretsä½¿ç”¨ã€ä¾èµ–é£é™©ï¼‰
            - æ€§èƒ½ä¸èµ„æºæ¶ˆè€—ï¼ˆå‰ç«¯æ¸²æŸ“ã€åç«¯è¯·æ±‚/DB IOçƒ­ç‚¹ï¼‰
            - æµ‹è¯•ç­–ç•¥ï¼ˆåç«¯Jestã€å‰ç«¯/ç«¯åˆ°ç«¯Playwrightï¼Œéœ€ç»™å‡ºè¡¥æµ‹å»ºè®®ï¼‰
            - å„¿ç«¥åº”ç”¨åˆè§„ä¸å†…å®¹å®‰å…¨ï¼ˆCOPPAã€å†…å®¹è¿‡æ»¤ã€å®¶é•¿å¯æ§ï¼‰

            è¾“å‡ºï¼š
            - ç”¨ä¸­æ–‡åœ¨PRä¸­è¯„è®ºï¼ŒæŒ‰â€œğŸ”´ä¸¥é‡/ğŸŸ¡å»ºè®®/ğŸŸ¢è‰¯å¥½â€æ ‡æ³¨
            - æŒ‡å‡ºå…·ä½“æ–‡ä»¶ä¸ä½ç½®ï¼Œç»™å‡ºå¯æ“ä½œæ”¹è¿›å»ºè®®æˆ–ç¤ºä¾‹
            - æœ€åç»™å‡ºåˆå¹¶å»ºè®®ï¼ˆblock/approve/neutralï¼‰åŠç®€è¦ç†ç”±
