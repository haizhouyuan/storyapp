• 完整开发计划

  - 阶段0：复杂度基准校准
      - 目标：为后续阈值设定提供数据依据。
      - 任务：采集≥30 条已通过审稿的工作流，统计 clueDensity（线索/章节经篇幅归一化）、嫌疑人关联
        度、twistCount、secondaryMysteryCount、Beta Reader 置信度、节奏指标；按题材/篇幅划分区间形
        成《复杂度指标基准表》。
      - 验证：基准表经创作/产品确认；提供可复用的统计脚本。
      - 执行记录（2025-10-25）：
          1. 当前仓库可用样本来自 `storage/exports/*` 共 5 份导出，均包含 `interactive.json`，其中 3 份含
             `story.txt` 章节文本。数量不足 30 条，暂记为基线样本。
          2. 编写脚本 `scripts/analysis/compute_complexity_baseline.mjs`，统计 clueCount、chapterCount、
             timelineCount、suspectCount，并输出到 `reports/complexity-baseline-stage0.json`。
             执行命令：
             `scripts/dev/nodehere node scripts/analysis/compute_complexity_baseline.mjs`
          3. 样本统计结果：平均 clueDensity≈1.0（3/5 样本可计算）、平均线索数 3.2、平均时间线节点 4.4、
             平均嫌疑人 2.4。部分样本缺少章节文本导致密度不可算，Beta Reader 指标暂无原始数据。
          4. 待办：补齐更多已审稿工作流（至少 25 条），补充 Beta Reader & 节奏评分原始数据源，完善脚本对
             Stage3/Stage4 artifacts 的解析。
  - 阶段1：Blueprint 扩展与双阶段规划
      - 目标：Blueprint 支持多幕、反转与误导节点，同时保持模型输出可靠。
      - 任务：
          1. 更新 DetectiveOutline & Schema，新增 actsCount、falseSolution、twists、
             secondaryMysteries、misdirectionMoments、角色级 redHerring、personality、arcBeats、
             beat 级 misleadPoint、emotionalShift 等字段。
          2. Planner Prompt 加入字段长度 guard（如 summary ≤160 字、falseSolution ≤120 字）、动态幕
             数模板；新增 token 预估，超出 maxTokens × 0.85 时改用精简模 板或回退三幕；记录 fallback
             类型。
          3. 实现 Stage1.5 “顾问分析”：Planner 首稿产出后，调用辅助 Prompt 生成改进建议（如补支线、
             调整顺序），再明确化地合并进 Outline。
      - 验证：Stage1 成功率≥97%，响应 token≤配额70%；Stage1.5 建议合并后 新增字段存在率≥95%。
      - 风险控制：若合并建议导致 Schema 失败，自动回滚并标记人工复核。
      - 执行记录（2025-10-25）：
          1. 扩展共享类型与 Schema：更新 `shared/src/types/detective.ts`、`shared/dist/types/detective.d.ts`、
             `shared/schema/detectiveOutline.schema.json`，新增 actsCount、falseSolution、twists、
             secondaryMysteries、misdirectionMoments、emotionalBeats、角色 personality/arcBeats 等字段。
          2. 调整 Planner Prompt（`backend/src/agents/detective/promptBuilder.ts`）引入动态幕数与长度限制，
             并在 Stage1 流程中记录 prompt 近似 token；新增 Stage1.5 顾问调用与合并逻辑（可通过
             `DETECTIVE_SKIP_STAGE1_ADVISOR=1` 关闭），仅允许合并 actsCount/falseSolution/twists/
             secondaryMysteries/misdirectionMoments/emotionalBeats/fairnessNotes/logicChecklist 等字段。
          3. 运行 `scripts/dev/nodehere npm run -w backend type-check` 确认 TypeScript 编译通过。
          4. 现有顾问补丁为浅合并策略（直接覆盖对应字段），后续需结合复杂度评估模块补充更精细的冲突处
             理与 diff 预览；Prompt token 超限时暂仅告警，精简模板 fallback 仍待实现。
  - 阶段2：大纲复杂度评估与单次补强
      - 目标：进入写作前把控线索密度、误导节奏与次要谜题。
      - 任务：
          1. assessOutlineComplexity 按阶段0基准配置阈值（篇幅归一化后判 断 clueDensity、
             suspectConnectivity、twistCount、secondaryMysteryCount、misleadPoint 覆盖率等）。
          2. 当任一指标低于阈值时触发一次补强 Prompt（整合 Stage1.5 建议 ），生成 diff artifact；补
             强最多 1 次，仍不达标则标记“需人工复核”。
          3. 对补强后的 Outline 做 Schema + token 校验，失败即回退并
  沿用原稿。
      - 验证：补强触发率 15–25%；触发后缺口指标提升≥15%，新增
  secondaryMysteries 覆盖率≥80%。
      - 执行记录（2025-10-25）：
          1. 新增 `backend/src/agents/detective/complexityToolkit.ts`，定义线索密度、嫌疑人数量、次要谜题等指标
             与默认阈值（clueCount≥4、clueDensity≥1.0、secondaryMystery≥1、twist≥1、misdirection≥1 等）。
          2. Stage1 完成后引入复杂度评估与自动补强流程：若评估状态为 retry，则向 Stage1.5 顾问追加
             deficits/metrics 信息再触发一次补强，并将前后指标写入 telemetry artifact（标签
             “Stage2 复杂度评估/补强后评估”）。
          3. 当自动补强仍未达标时会记录 warn，并保留补强后的输出供 Stage3 参考；可通过
             `DETECTIVE_COMPLEXITY_AUTO_RETRY=0` 关闭自动补强。
          4. TypeScript 校验已通过；待办：补充真实样本集以校准阈值，并在复杂度失败时新增 diff 视图/人工
             审核流程。
  - 阶段3：角色人格与嫌疑人多样化闭环
      - 目标：让 personality/arcBeats 在写作与审稿阶段均有可验证落地。
      - 任务：
          1. Stage2 写作 Prompt 强制引用 personality、arcBeats; 新增
  configureSuspects 在 Stage1.5
             后为嫌疑人分配差异化性格/行为并写入 clueMatrix/acts（含“胆小
  证词矛盾”等）。
          2. 实现 enhanceCharacterIntroductions（写作后执行）与“弧线兑现
  检查”：对每个 arcBeats 生成
             (章节,关键词) 清单，若正文缺失则生成具体补写句并加入
  Revision must-fix。
          3. StylePack 依据 personality 匹配细分模板（胆小/暴躁等），限制
  filler 过度；在 Stage4 后
             再执行一次 personality 关键词抽样校验。
      - 验证：首次出场命中 personality 关键词≥80%；arcBeats 检测通过率
  ≥90%，未通过项带具体章节建
        议；嫌疑人性格差异指标（对话/行为分析）较旧版提高≥20%。
      - 执行记录（2025-10-25）：
          1. 新增 `backend/src/agents/detective/characterToolkit.ts`，提供 `ensureSuspectPersonas`、
             `enhanceCharacterIntroductions`、`evaluateArcBeats` 等工具；Stage1 在规范化蓝图后调用
             `ensureSuspectPersonas` 自动补充嫌疑人性格与 arcBeats。
          2. Stage2 写作流程中新增“角色首章增强”步骤：在语气/陈词处理后为每位嫌疑人的首次出场追加性格描写，
             并将完成情况写入 telemetry；修订阶段引入弧线缺口检测，将缺失的 arcBeat 生成 must-fix 条目（Stage4
             前后均执行一次）。
          3. TypeScript 检查已通过；后续需在 StylePack 中细化 personality→语气映射，并为 arcBeat 缺失提供
             更细致的补写模板。
  - 阶段4：误导设计、真相逆推与顺序校验
      - 目标：确保误导节点丰富、结局可逆推且 Blueprint↔Draft 同步。
      - 任务：
          1. generateRedHerringSuggestions 根据 Review 缺口输出 JSON（章
  节、红鲱鱼角色、误导手法、
             澄清提示）；Revision Prompt 明确引用。
          2. 完成后生成 Outline vs Draft diff（包含 misdirectionMoments、
  timeline、acts/beats）；若
             diff 涉及案发时间、核心线索，触发人工复核或重新进入 Stage1/2
  流程。
          3. 新增校验：validateTruthReconstruction（基于 clueGraph 检查
  solution 每个要点都有线索支
             撑）、validateClueOrder（关键真相线索需晚于至少一条红
  鲱鱼）。
          4. Stage4 结束时若 Revision 采纳建议，回写 misdirectionMoments
  与角色 redHerring，重新执
             行时间线/锚点校验。
      - 验证：Beta Reader 置信度≥0.85 的案例中，Revision 后下降≥0.15；
        validateMisdirectionDeployment 警告率 <10%；新“逆推”规则通过
  率≥90%。
      - 执行记录（2025-10-25）：
          1. 新增 `backend/src/agents/detective/misdirectionToolkit.ts`，实现红鲱鱼建议生成与 RevisionPlan 合并；
             Stage4 根据复杂度与 Beta Reader 信心输出 `红鲱鱼增强建议` artifact，并在修订计划中自动加入定制化
             建议条目。
          2. 扩展 Stage4 校验：新增 `validateTruthReconstruction`（核查 solution.keyReveals 是否在正文体现）、
             `validateClueOrder`（对比红鲱鱼与真实线索的出场顺序），确保结局可逆推与误导节奏合理。
          3. TypeScript 检查通过；Diff 同步机制仍待与 Blueprint 回写流程整合，后续将引入更细颗粒度的
             misdirection diff 视图。
  - 阶段5：语言与节奏强化
      - 目标：在独立 Stage5 内增强语言感染力与节奏张弛。
      - 任务：
          1. 构建 figurative/imagery 词库，开发 applyFigurativeLanguage
  和 narrativeCadenceAdjust；
             根据章节 narrativeStyle（紧凑/舒缓）或主题 themes 调整句长与
  用词。
          2. 统计章节结尾悬念、高潮章字数、感官描写；观察期只生成指标与建
  议，确认准确度后再由编辑
             Prompt 自动润色。
          3. 若需要自动补悬念句，在非终章末尾追加模板（含当章线索），但踩
  灯条件需通过规则判定避免
             重复。
      - 验证：悬念结尾覆盖率≥75%；高潮章字数≥目标 110%；感官描写较 Stage4
  提升≥15%； figurative 替
        换命中率≥60%，误判率<5%。
      - 执行记录（2025-10-25）：
          1. 新增 `backend/src/agents/detective/rhythmToolkit.ts`，实现节奏指标统计（悬念覆盖率、高潮章篇幅、
             感官密度、比喻替换次数）及基础 figurative 词库；StageRunner 暴露 `runStage5RhythmAnalysis` 以
             供管线或工具链调用。
          2. 当启用 `DETECTIVE_STAGE5_POLISH=1` 或调用参数 `applyPolish=true` 时，会自动执行陈词替换并在
             telemetry 中记录替换次数；默认运行仅输出指标与建议。
          3. 目前未强制补悬念句，需在后续版本结合指标观察与人工反馈再决定自动改写策略。
  - 阶段6：读者投入与难度调节
      - 目标：提升读者互动感与节奏动态平衡。
      - 任务：
          1. 在 Prompt 中明确“章节结尾悬念 + 疑问句”要求；新增 difficulty
  参数影响 Beta Reader 阈
             值、线索显性程度和 Stage4 must-fix 触发条件。
          2. 允许 Blueprint fairnessNotes 提供“读者视角提示”；Stage4 检查
  提示是否在正文中有显性
             描写。
          3. 计划阶段后续可选：在输出 JSON 附 riddles 字段（可配置开
  启），或在 Review 结果中加入
             engagement 评分。
      - 验证：不同难度下 Beta Reader 置信度落在预期区间（易：50–80%，难：
  <60%）；“读者提示缺失”警告
        率<10%；悬念问句检测准确率≥90%。
      - 执行记录（2025-10-25）：
          1. 写作 Prompt 新增悬念结尾与读者提示要求（`backend/src/agents/detective/promptBuilder.ts:202`），确保模型生成时主动保留章节疑问和旁白提醒。
          2. Stage3 Beta Reader 阈值随 `difficulty` 动态调整（`backend/src/agents/detective/stageRunner.ts:2931`），并在 telemetry 中记录阈值；高置信度且无竞争嫌疑时须加强误导。
          3. Stage4 新增 `validateFairnessNotesExposure` 与既有 fair-play 校验联动（`backend/src/agents/detective/validators/stage4Validator.ts:20`），缺失读者提示时发出告警；新增 `validateTruthReconstruction`、`validateClueOrder` 已在阶段4记录。
          4. 后续需基于 Stage5 悬念指标数据决定是否自动补悬念句，并评估 fairnessNotes 的更细粒度匹配（关键词提取）。
  - 阶段7：Telemetry 与治理
      - 目标：确保新增流程可观测、可回溯。
      - 任务：
          1. 每阶段输出标准化 artifact（token 使用、补强原因、人物弧线命
  中率、误导建议采纳率、节奏
             指标、diff 摘要）；构建聚合脚本生成日报。
          2. 失败时记录 error code、上下文与重试次数（≤2），确保回溯
  可用。
          3. 控制日志体积：最近 N 次失败保留详细信息，其余归档。
      - 验证：关键指标在报表中可直接查询；报警可关联到具体 artifact；无未
  记录的自动重试。
      - 执行记录（2025-10-25）：
          1. StageRunner 新增统一的 `recordStageMetrics` 流程（`backend/src/agents/detective/stageRunner.ts:120`），Stage1~Stage5 均会输出结构化指标 Artifact，并可选写入 `reports/telemetry/` 目录。
          2. 追加 `scripts/analysis/aggregate_telemetry.mjs`，可聚合 `reports/telemetry/*.json` 生成日报式汇总（输出至 `reports/telemetry-summary.json`）。
          3. 引入本地 retention 策略，仅保留最近 50 份指标文件，可通过环境变量 `DETECTIVE_METRICS_DIR`/`DETECTIVE_METRICS_RETENTION`/`DETECTIVE_METRICS_DISABLE` 调整。
