• 创作流程可视化方案

  - 整体目标：面向 StoryReader 页面，新增“创作日志”浮层，实现从生成按钮到朗读完成的实时可视化。展示阶段进度、动态事件、操作入口（跳转正文/导出/
    朗读），并对失败场景提供回退提示。
  - 触发时机
      - ReaderHomePage 触发 createWorkflow 后，即刻打开日志浮层并订阅工作流事件。
      - 若带着已有 workflowId 进入 StoryReader 页面，首次加载时请求过去的日志快照并进入追踪模式，使“回放”与“实时”统一。
  - 数据通道
      1. 阶段事件 SSE/WebSocket
          - 后端 detectiveWorkflowService 在 Stage1-4 各环节调用 logger.info 时同步写入 story_logs，并通过新建的广播服务推送事件（使用 ws 或
            EventSource）。
          - 新增 /api/story-workflows/:id/stream（SSE）或 /ws/story-workflows/:id；每条事件包含 stageId, status, message, timestamp, meta。
      2. TTS 状态
          - 保留现有 /api/tts/synthesize-story 返回；完成后写入 ttsManager 的 taskRegistry（已有）。
          - 新增 /api/tts/tasks/:storyId/latest，供前端获取最近合成状态（成功/失败/音频地址）。
          - 后端在 TTS 成功/失败时写入 story_logs，故事流程日志与朗读统一呈现。
  - 前端 UI/UX

    | 区域 | 功能 | 交互 |
    | --- | --- | --- |
    | 页面右上角浮层入口 | 小按钮显示当前阶段图标/状态色 | 点击展开侧边抽屉；生成中自动展开 |
    | 侧边抽屉头部 | “创作进度”标题 + 状态 pill + 关闭按钮 | 状态 pill 显示 overall 状态（进行中、成功、失败） |
    | 时间轴列表 | 阶段卡片（Stage1~4） + TTS 阶段 + 保存导出 | 每卡片包含：阶段名、状态图标、耗时、实现的事件列表（流式插入），使用打字机或淡入
    动画 |
    | 事件项 | 包括时间戳、简短描述、可选 action 链接（如“跳转正文第3章”） | 点击 action 调用 scrollIntoView 或 navigate |
    | 底部操作 | “导出故事”“朗读整篇”“重试失败阶段” | 根据状态显示可用/禁用；失败时显示橙色警告文本 |
    | 移动端 | 浮层压缩为底部横条；打开时改为全屏抽屉 | 上滑滑出日志，下滑收起，保留操作按钮 |
  - 动画/视觉
      - 使用 Framer Motion/Tailwind：进度条从左至右流光；阶段完成时卡片轻微闪烁。
      - 打字机效果实现：事件文本逐字显现，可用自定义 hook 或 Framer Motion animate。
      - 状态色：蓝（running）、绿（completed）、橙（warning）、红（failed）。
  - 后端开发步骤
      1. 日志广播服务
          - 新增 backend/src/services/streaming：封装 SSE，维护 Map<workflowId, Set<res>>。
          - 在 detectiveWorkflowService 和 ttsManager 中 hook 关键事件（stage start/end、TTS 成功/失败）调用 broadcast(workflowId, event).
      2. 事件模型
          - 定义统一类型 WorkflowEvent（stageId、status、title、detail、chapterIndex、relativeLink、timestamp、duration）。
          - 将现有 logger.info(...) 位置调整为返回结构化数据（可重用 logEntry EventType 字段；如 Story generation start, Stage2 writing chapter
            3 等）。
      3. SSE 路由
          - /api/story-workflows/:id/stream：校验 ID，写入 response headers (text/event-stream)，初始推送当前阶段状态，再监听 close 解绑。
      4. 历史查询
          - /api/story-workflows/:id/events：查询 story_logs（已记录 EventType），转换为 WorkflowEvent 数组，供刷新或断线重连。
      5. TTS 关联
          - 在 ttsManager 完成/失败时广播 tts_synthesis_success/tts_synthesis_failed，附 audioUrl 或错误信息。
          - taskRegistry 保留原功能，可在新端点 /api/tts/tasks/:storyId/latest 使用。
      6. 权限控制 & 资源清理
          - 注意 SSE 连接存活时间；在 app.ts 新增中间件 req.on('close') 清理。
          - 确保广播不会泄露敏感数据；只暴露 stage-level 信息。
  - 前端开发步骤
      1. 状态管理 Hook
          - 新建 frontend/src/hooks/useWorkflowStream.ts：接受 workflowId 和初始事件列表，通过 EventSource 订阅 SSE；提供 events, stageStatus,
            isConnected, retry。
          - 增加 useWorkflowEvents context，在 StoryReaderPage、创作日志组件中共享。
      2. UI 组件
          - 新建 components/WorkflowTimeline.tsx：渲染阶段卡片（可使用 PointsSection 风格）。每阶段 accepts events filtered by stageId。
          - 新建 components/WorkflowDrawer.tsx：封装 Drawer/浮层逻辑；支持 isOpen、toggle；动画使用 Framer Motion slideIn.
      3. StoryReader 集成
          - 当 useDetectiveWorkflow 返回加载完成后，渲染 Drawer 入口；useEffect 订阅 useWorkflowStream.
          - 当事件包含 chapterIndex，提供 “查看正文” 按钮 -> scrollIntoView.
          - TTS 成功事件 -> 触发 Toast + 自动展开朗读面板。
      4. ReaderHomePage 交互
          - 生成后 navigate 到 StoryReader 同时携带 openTimeline: true state 让抽屉默认展开。
          - 在生成阶段中 ReaderHomePage 也可显示 mini progress（可复用 stream hook，但初期可只在 StoryReader 展示）。
      5. 移动端适配
          - 使用 @media (max-width:768px)：Drawer 改为底部弹出，height 70%。
          - 入口按钮固定在页面右下角（FAB）。
      6. 错误/断线处理
          - SSE 断开 -> Toast 提示 & 自动重连。
          - 如果 API 返回 503（例如 workflow 未启动），展示 “等待工作流开始” 提示。
      7. 测试
          - 单元：Hook mock SSE；组件 snapshot。
          - E2E (Playwright)：模拟 workflow 事件 stream（可 mock SSE endpoint 或在测试中手动推送事件）验证时间轴显示。
          - 手动检查 TTS 成功/失败场景 UI。
  - 时间预估（参考）
      1. 后端 SSE & 事件模型：1.5 天
      2. 前端 hooks + Drawer UI：2 天
      3. TTS 与事件打通 + QA：1 天
      4. 动效/响应式细化：0.5 天
      5. E2E/文档更新：0.5 天
         总计 ~5 天（可与现有任务交错开发）
  - 后续演进
      - 支持手动刷新/跳转至历史版本事件。
      - 将日志写入 story_logs，Appsmith 后台可直接消费。
      - 考虑与 tts-task 接口整合，支持播放失败重试。

  如认可此方案，可先着手后端事件模型与 SSE 路由，再并行构建前端 Drawer/时间轴组件。

---

## 2025-10-19 实施补充记录

- ✅ 前端 `WorkflowTimelineDrawer` 按方案落地：按钮移至右上角、抽屉在移动端改为底部滑出，事件列表支持淡入动画与点击跳转，底部新增导出/朗读/重试操作区。
- ✅ `useWorkflowStream` 增加断线 Toast、手动刷新、重连提示，`StoryReaderPage` 根据抽屉状态自动预留右侧空间，确保正文按钮可点击。
- ✅ 后端补充 `/api/tts/tasks/:storyId/latest` 与测试辅助 `/api/story-workflows/:id/test-events`，前端抽屉自动补齐 TTS 最新状态。
- ✅ Appsmith 与监控待办：已在方案中记录下一步需同步的仪表盘字段（workflowId、实时事件数据），后续更新文档与查询脚本。
