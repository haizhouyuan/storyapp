# 服务器资源分配规划

## 🖥️ 服务器基本信息

**服务器地址**: `47.120.74.212`  
**操作系统**: Linux  
**用户**: `root`  
**项目根目录**: `/root/projects/`

## 📊 端口分配规划

### StoryApp 项目端口分配

| 服务名称 | 内部端口 | 外部端口 | 状态 | 域名 |
|---------|---------|---------|------|------|
| **StoryApp Frontend** | 3000 | - | 生产环境内置 | https://storyapp.dandanbaba.xyz |
| **StoryApp Backend** | 5000 | 5001 | ✅ 已分配 | - |
| **StoryApp MongoDB** | 27017 | 27017 | ✅ 已分配 | - |
| **StoryApp Nginx** | 80/443 | 80/443 | ✅ 已分配 | - |

### 预留端口范围

| 端口范围 | 用途 | 分配项目 | 状态 |
|---------|------|----------|------|
| **5001-5010** | StoryApp 相关服务 | StoryApp | ✅ 已分配 |
| **5011-5020** | 项目2 | 待分配 | 🟡 预留 |
| **5021-5030** | 项目3 | 待分配 | 🟡 预留 |
| **5031-5040** | 项目4 | 待分配 | 🟡 预留 |
| **5041-5050** | 项目5 | 待分配 | 🟡 预留 |

### 数据库端口分配

| 数据库类型 | 端口 | 分配项目 | 状态 |
|-----------|------|----------|------|
| **MongoDB** | 27017 | StoryApp | ✅ 已分配 |
| **MySQL** | 3306 | 待分配 | 🟡 预留 |
| **PostgreSQL** | 5432 | 待分配 | 🟡 预留 |
| **Redis** | 6379 | 待分配 | 🟡 预留 |

## 🗂️ 项目目录结构

```
/root/projects/
├── storyapp/                    # ✅ StoryApp 项目
│   ├── docker-compose.yml
│   ├── docker-compose.prod.yml
│   ├── .env.prod
│   └── ...
├── project2/                    # 🟡 待分配
├── project3/                    # 🟡 待分配
├── project4/                    # 🟡 待分配
└── shared/                      # 🔧 共享资源
    ├── nginx/                   # 全局 Nginx 配置
    ├── ssl/                     # SSL 证书
    └── scripts/                 # 管理脚本
```

## 🌐 域名分配

| 域名 | 项目 | 端口 | SSL | 状态 |
|------|------|------|-----|------|
| **storyapp.dandanbaba.xyz** | StoryApp | 5001 | ✅ | ✅ 已配置 |
| **project2.dandanbaba.xyz** | 项目2 | 5011 | 🟡 | 🟡 待配置 |
| **project3.dandanbaba.xyz** | 项目3 | 5021 | 🟡 | 🟡 待配置 |
| **api.dandanbaba.xyz** | API Gateway | 8080 | 🟡 | 🟡 待配置 |

## 💾 资源限制

### StoryApp 资源配置

```yaml
# Docker Compose 资源限制
services:
  app:
    deploy:
      resources:
        limits:
          cpus: '1.0'        # 最大1核CPU
          memory: 1G         # 最大1GB内存
        reservations:
          cpus: '0.5'        # 保留0.5核CPU
          memory: 512M       # 保留512MB内存
  
  mongo:
    deploy:
      resources:
        limits:
          cpus: '0.5'        # 最大0.5核CPU
          memory: 512M       # 最大512MB内存
        reservations:
          cpus: '0.25'       # 保留0.25核CPU
          memory: 256M       # 保留256MB内存
```

### 服务器整体资源规划

| 资源类型 | 总量 | StoryApp分配 | 其他项目可用 |
|---------|------|-------------|-------------|
| **CPU** | 假设4核 | 1.5核 (37.5%) | 2.5核 (62.5%) |
| **内存** | 假设8GB | 1.5GB (18.75%) | 6.5GB (81.25%) |
| **磁盘** | 假设100GB | 20GB (20%) | 80GB (80%) |

## 🔧 管理工具

### 端口占用检查命令

```bash
# 检查端口占用
netstat -tlnp | grep :5001

# 检查所有已用端口
ss -tulpn | grep LISTEN

# 检查特定端口范围
for port in {5001..5050}; do
  if netstat -tlpn | grep ":$port " >/dev/null; then
    echo "端口 $port 已被占用"
  fi
done
```

### 项目资源使用监控

```bash
# 查看Docker容器资源使用
docker stats

# 查看系统资源
htop
free -h
df -h
```

## 📋 新项目部署检查清单

### 部署前检查

- [ ] 确认端口范围可用
- [ ] 检查域名DNS配置
- [ ] 验证SSL证书
- [ ] 确认资源限制设置
- [ ] 测试数据库连接

### 部署后验证

- [ ] 服务健康检查
- [ ] 端口访问测试
- [ ] 资源使用监控
- [ ] 日志输出正常
- [ ] 备份机制验证

## 🚨 注意事项

### 端口冲突预防

1. **严格按照分配表使用端口**
2. **部署前必须检查端口占用**
3. **使用Docker网络隔离**
4. **避免使用系统保留端口**

### 资源冲突预防

1. **为每个项目设置资源限制**
2. **监控总体资源使用率**
3. **预留系统资源 (至少20%)**
4. **定期清理无用容器和镜像**

### 数据隔离

1. **每个项目使用独立数据库**
2. **使用项目前缀命名**
3. **定期备份重要数据**
4. **避免跨项目数据依赖**

## 📞 协调机制

### 新项目申请流程

1. **提交项目部署申请**
   - 项目名称和描述
   - 预期资源需求
   - 域名需求

2. **资源分配确认**
   - 检查端口可用性
   - 评估资源需求
   - 分配端口范围

3. **部署前验证**
   - 配置文件审查
   - 端口冲突检查
   - 资源限制确认

4. **部署后更新**
   - 更新资源分配表
   - 添加监控配置
   - 文档同步更新

### 联系方式

- **资源冲突**: 检查本文档并协调
- **部署问题**: 查看项目日志
- **紧急情况**: 使用管理脚本快速处理

---

**更新时间**: 2025-09-13  
**下次审查**: 2025-10-13  
**维护人员**: 系统管理员