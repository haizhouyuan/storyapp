# 服务器端容器部署方案调查报告（StoryApp）

> 目标：给出在生产服务器上可靠、安全、可观测地运行 StoryApp 的完整容器部署方案与落地清单。

## 一、执行摘要
- 运行时：Docker + Docker Compose，应用镜像内置前后端，MongoDB 独立容器，按需 Nginx 反向代理。
- 配置源：根目录 `.env`（包含 DeepSeek 密钥与运行参数），Compose 基座 `docker-compose.yml` + 环境覆盖文件。
- 端口与暴露：应用容器内端口 `5000`，推荐对外经 Nginx 暴露 `80/443`；本地检查用 Host `5001`。
- 数据与日志：`mongo_data`、`app_logs`、`app_uploads` 持久化卷；Docker 日志滚动；应用层详细日志在生产关闭。
- 可观测与健康：`/healthz` 与 `/api/health` 健康检查，TTL 索引自动清理日志，Appsmith 管理后台可视化。
- 上线策略：优先使用手工分步部署与验证；支持蓝绿切换；提供回滚与备份恢复路径。

---

## 二、服务器基线与准备
- 系统与安全
  - 升级安全补丁；开启自动安全更新（如 `unattended-upgrades`）。
  - SSH 仅允许密钥登录，禁用密码；启用 `fail2ban`（可选）。
  - 防火墙允许：`22`、`80`、`443`（如直连应用再临时允许 `5001`）。
  - 设置时区与 NTP，同步服务器时间。
- Docker 运行环境
  - 安装 Docker Engine 与 Compose 插件；将管理用户加入 `docker` 组（或使用 root）。
  - 配置 Docker 日志滚动（/etc/docker/daemon.json）：
    ```json
    {
      "log-driver": "local",
      "log-opts": { "max-size": "10m", "max-file": "5" }
    }
    ```
  - 重启 Docker：`systemctl restart docker`。
- 目录与仓库
  - 代码路径：`/root/projects/storyapp`。
  - 拉取仓库与 `.env`（勿提交到 Git）：`DEEPSEEK_API_KEY` 必填，`APP_PORT=5001` 建议统一。

---

## 三、容器与网络拓扑
- Compose 基座：`docker-compose.yml`
  - 服务：`mongo`（持久化）、`app`（Node + 前端静态）、可选 `nginx`（profile 触发）。
  - 网络：`storyapp-net`（bridge）。
  - 卷：`mongo_data`、`app_logs`、`app_uploads`。
  - 健康检查：`mongo` 使用 `mongosh ping`，`app` 使用 `GET /healthz`。
- 环境覆盖：
  - 开发：`docker-compose.dev.yml`（源码挂载、无认证 Mongo、本机 `5001->5000`）。
  - GHCR 验证：`docker-compose.ghcr.yml`（生产镜像验证、端口 `5002`）。
  - CI：`docker-compose.ci.yml`（流水线测试专用）。
- 端口建议
  - 生产对外经 Nginx 暴露 `80/443`；`app` 仅在容器网络内可见，避免直接对外暴露。
  - 本地/生产检查用 `APP_PORT=5001` 暂时映射主机 5001→容器 5000；上线后切回仅 Nginx 对外。

---

## 四、反向代理与 TLS（Nginx）
- 配置文件位置
  - Compose 基座当前挂载 `./ops/nginx/conf.d:/etc/nginx/conf.d:ro`
  - 代码库配置位于 `./nginx/conf.d/storyapp.conf`
  - 建议其一：
    - 将 Compose 挂载改为 `./nginx/conf.d:/etc/nginx/conf.d:ro`，或
    - 新建符号链接 `ops/nginx/conf.d -> nginx/conf.d`，保持现有 Compose 不变。
- 站点设置
  - `nginx/conf.d/storyapp.conf` 已包含：
    - API 与静态代理到 `app:5000`
    - 速率限制、基础安全头、Gzip、SPA 回退
  - 生产启用 TLS：
    - 使用 Certbot 于宿主机签发，挂载 `/etc/letsencrypt` 只读进 Nginx（需额外 volume）
    - 反代场景下设置后端 `TRUST_PROXY=true`（`.env`）
- DNS 与域名
  - 将域名 A 记录指向 `47.120.74.212`，`server_name` 替换为你的域名。

---

## 五、环境变量与密钥
- 生产 `.env` 关键项（勿提交）：
  ```bash
  NODE_ENV=production
  PORT=5000
  APP_PORT=5001               # 主机检查端口（可选）

  # Mongo（生产开启认证并使用强口令）
  MONGO_USER=root
  MONGO_PASS=<strong_password>
  MONGO_DB=storyapp

  # DeepSeek（必填）
  DEEPSEEK_API_KEY=<your_deepseek_api_key>
  DEEPSEEK_API_URL=https://api.deepseek.com

  # 日志与保留
  ENABLE_DETAILED_LOGGING=false
  LOG_LEVEL=info
  LOG_RETENTION_DAYS=30

  # 反代/安全
  TRUST_PROXY=true
  CORS_ORIGINS=https://<your-domain>
  ```
- 权限：限制 `.env` 为 `chmod 600 .env`。
- 镜像来源（可选）：使用 GHCR 需 `docker login ghcr.io` 并设置 `APP_TAG`。

---

## 六、数据持久化与备份
- 持久化卷
  - `mongo_data`：数据库数据
  - `app_logs`：应用日志（容器内 `/app/logs`）
  - `app_uploads`：上传与静态生成内容
- TTL 与索引
  - 启动时由 `backend/src/config/initializeDatabase.ts` 自动创建：
    - `stories`：`created_at`、`title` 文本索引
    - `story_logs`：单字段/复合索引 + TTL（`timestamp` 按 `LOG_RETENTION_DAYS` 过期）
- 备份策略
  - 建议宿主机 cron 每日 `mongodump`：
    ```bash
    docker exec storyapp-mongo \
      mongodump -u "$MONGO_USER" -p "$MONGO_PASS" --authenticationDatabase admin \
      --out /data/backup/$(date +%F)
    ```
  - 将 `/data/backup` 挂载或复制到宿主 `/root/backups/storyapp`，并异地存储（OSS/S3）。
  - 定期演练恢复：`mongorestore` 到隔离数据库验证可用性。

---

## 七、可观测性与管理后台
- 健康与就绪
  - 中间件与路由已提供 `/healthz`、`/api/health`，Compose 健康检查对接。
- 日志与等级
  - 生产：`ENABLE_DETAILED_LOGGING=false`、`LOG_LEVEL=info`；避免敏感信息出现在日志。
  - Docker 日志滚动 + 应用卷 `app_logs`，集中查看与清理。
- Appsmith 管理后台
  - 导入 `appsmith-story-admin.json`
  - 数据源：
    - MongoDB：`mongodb://localhost:27017/storyapp`（或含认证）
    - REST：`http://localhost:5001/api/admin`（或经域名）
  - 按 `docs/APPSMITH_SETUP.md` 完成对接。

---

## 八、安全加固
- 容器与权限
  - 应用镜像已使用非 root 用户 `storyapp` 运行。
  - 可在 Compose 增加：`read_only: true`（除需写目录外）、`no-new-privileges`、按需 `cap_drop`。
- 网络与暴露
  - `mongo` 不对宿主机暴露端口；仅容器网络访问。
  - 使用 Nginx 作为唯一对外入口；避免直接暴露 `app`。
- 速率限制与安全头
  - Nginx 已启用 `limit_req` 与基础安全头/CSP；根据前端依赖域适度放宽 `connect-src` 等。

---

## 九、部署与更新流程
- 手工分步（推荐，与你的指南一致）
  ```bash
  # 构建与启动（首次/更新）
  docker compose -f docker-compose.yml build --no-cache app
  docker compose -f docker-compose.yml up -d mongo
  docker compose -f docker-compose.yml up -d app

  # 可选：启动 Nginx（修正挂载路径后）
  docker compose -f docker-compose.yml --profile nginx up -d nginx

  # 健康与日志
  curl http://localhost:5001/api/health
  docker compose -f docker-compose.yml logs -f app
  ```
- 蓝绿发布（零停机，可渐进切换）
  - 启动第二个应用实例（如 `app-staging`），Nginx 已预留 `upstream app_staging`。
  - 验证后将流量切换到 `app_staging`，平滑迁移与回滚。
- 回滚
  - GHCR：切换到前一标签 `sha-xxxxxxx` 并 `up -d`。
  - 本地构建：保留上一镜像 ID，本地验证后再切回。

---

## 十、扩容与性能
- 垂直扩容：确保 Node 与 Mongo 内存充足（Node 堆 <70%）。必要时设置 `--max-old-space-size`。
- 水平扩容：应用无状态可 `--scale app=2`，Nginx 做轮询；仅引入会话状态时再考虑粘性会话。
- 资源约束：如需隔离资源，可在 Compose 设定 `cpus`、`mem_limit`（按主机容量评估）。

---

## 十一、生产验证与测试
- 服务器上执行 E2E（避免本地误测）：
  ```bash
  cd /root/projects/storyapp
  npx playwright install
  npx playwright test -c playwright.prod.config.ts
  ```
- API 冒烟测试：
  ```bash
  curl http://localhost:5001/api/health
  curl -X POST http://localhost:5001/api/generate-story \
    -H 'Content-Type: application/json' \
    -d '{"topic":"宇航员小熊","maxChoices":6}'
  ```

---

## 十二、风险与权衡
- Compose 简洁但不原生提供滚动更新/HA：通过蓝绿与备份演练弥补。
- GHCR 依赖访问令牌：失效会影响拉取；保留本地构建路径作为兜底。
- TLS 运维开销：Certbot 自动续期与容器化证书管理需规范流程；可考虑 Caddy/Traefik 简化。

---

## 十三、上线清单（Checklist）
- 基线
  - [ ] 系统/SSH/防火墙加固完成
  - [ ] Docker 与日志滚动配置完成
- 配置
  - [ ] `.env` 填写并 `chmod 600`（含 `DEEPSEEK_API_KEY`、Mongo 口令）
  - [ ] `APP_PORT=5001`（如需宿主检查端口）
  - [ ] `TRUST_PROXY=true`（若经 Nginx）
- 部署
  - [ ] `mongo` 与 `app` 启动健康
  - [ ] Nginx 挂载路径修正并启用（80/443）
  - [ ] TLS 证书签发并自动续期
- 数据
  - [ ] TTL 索引生效（`LOG_RETENTION_DAYS`）
  - [ ] 备份脚本与异地存储上线
- 可观测
  - [ ] Appsmith 导入并配置数据源
  - [ ] 健康检查、日志策略确认
- 验证
  - [ ] E2E 测试通过
  - [ ] 冒烟 API 检查通过

---

## 附录：常用命令
```bash
# 基本运维
docker compose -f docker-compose.yml ps
docker compose -f docker-compose.yml logs -f app

docker compose -f docker-compose.yml exec app sh

docker compose -f docker-compose.yml down

# 清理
docker system prune -f

# 网络排查
docker network inspect storyapp_storyapp-net

# Mongo 调试
docker exec -it storyapp-mongo mongosh
```

以上方案与清单与仓库现有的 Compose/Dockerfile/Nginx/环境变量规范完全对齐，可直接在 `47.120.74.212` 的 `/root/projects/storyapp` 按步骤落地，并支持平滑演进（蓝绿、监控、备份与安全策略完善）。

