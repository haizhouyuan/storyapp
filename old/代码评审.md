

codex
总体结论

- 后端业务接口齐全且防护到位：已实现生成故事、保存/查询、健康检查、TTS占位；有速率限制、Helmet、CORS、统一错误处   
理、10MB体积限制和中文错误信息。
- 数据层已从 Supabase 迁移到 MongoDB，集合与索引初始化完备；但文档与部分配置仍停留在 Supabase 叙述，存在认知偏差   
风险。
- 前端完成两条核心用户路径：渐进交互模式与“故事树”模式；视觉与交互更偏儿童友好，但两条路径在“结束/保存”环节打通不一
致，影响业务闭环。
- 测试具备端到端场景，但当前与端口、路由与模式选择存在错配，影响“一键跑通”。

后端业务流程

- 接口覆盖

    - POST /api/generate-story：按主题和上下文生成500+字片段+最多3个选项；支持“强制结尾”和字数补齐（二次扩展       
调用）。
    - POST /api/save-story：以标题、内容（JSON字符串）入库，返回插入ID；有验证与错误语义。
    - GET /api/get-stories：按时间倒序返回列表+预览；GET /api/get-story/:id：返回详情。
    - POST /api/generate-full-story：预生成“故事树”（3轮→4个结局），存在“Reasoner+Chat协作生成/审校”与“无Key下使用 
模拟数据”的兜底。
    - GET /api/health：检查server/db/deepseek；若缺少DeepSeek Key则为“unhealthy”(503)。
    - GET /api/tts：占位。
- 健壮性
    - 输入校验与中文错误码覆盖关键参数；统一捕获下游错误并转业务语义码（如 DEEPSEEK_API_ERROR、DATABASE_ERROR）。  
    - 速率限制可通过 RATE_LIMIT_* 环境变量调优；Helmet 与 CORS 基本合理。
- 风险/改进
    - Health 依赖 DeepSeek Key 才“healthy”：建议将 DeepSeek 作为“可选依赖”（缺失时降级为 warn，但不致503），方便纯 
数据库/前端回归。
    - DeepSeek 客户端配置里的 httpsAgent: false 非标准用法；如需直连/代理配置，建议改为显式 new https.Agent(...) 或
移除。
    - 类型重复：shared/types 与 backend/src/types 存在重复定义，后续易漂移。

数据与持久化

- 存储形态
    - stories 集合：title、content（JSON字符串或纯文本）、created_at/updated_at。
    - 索引初始化：created_at、title text，与查询路径匹配。
- 业务一致性
    - 列表预览生成逻辑仅识别 content.storySegment，而前端保存内容是整段 JSON（含 fullStory 而非 storySegment），导 
致预览常退化为 JSON 开头片段，不够友好。
    - 建议：保存结构固定化（如 {topic, fullStory, outline, paths,...}），并更新后端 generatePreview 识别 fullStory/path[0].segment 等字段。                                                                                           
                                                                                                                   
前端业务流程                                                                                                       
                                                                                                                   
- 渐进模式（/story）                                                                                               
    - 首次生成片段→显示3个选项→选择推动下一片段；用 turnIndex/maxChoices/forceEnding 约束回合收束；完结后到        
EndPage，支持“保存到我的故事”。                                                                                    
    - 体验完整，状态管理清晰（StorySession）。                                                                     
- 故事树模式（/story-tree）                                                                                        
    - 进入即生成完整树（有AI/模拟双路径），每轮2选，3轮到结局；交互稳定、动画与视觉良好。                          
    - 关键缺口：                                                                                                   
    - 结束后 `navigate('/end', { state: { topic, storyTree, finalPath } })`，但 EndPage 依赖 `storySession` 才渲   
染，导致树模式结束直接被重定向回首页，无法展示“结束页/保存”。                                                      
    - 树模式缺少“保存故事”能力（未将选择路径合成为可保存的 `content`）。                                           
- 建议：为故事树模式实现独立的“结束/保存”流程                                                                      
    - 方案A：扩展 EndPage 兼容 `location.state`（树模式），生成 `fullStory` 文本并调用 `POST /api/save-story`。    
    - 方案B：新增 `EndTreePage`，与 EndPage 类似但基于树会话生成内容并保存。                                       
- 我的故事（/my-stories）                                                                                          
    - 列表页使用后端 preview，点击卡片仅展示预览文案，未请求详情；建议点击后调用 GET /api/get-story/:id 并展示解析 
后的 fullStory。                                                                                                   
    - “删除”仅占位；后端也未实现删除接口。                                                                         

测试与可观测性

- Playwright（本地）
    - playwright.config.ts 启动后端期望 http://localhost:5000，而后端默认/当前 .env 为 5001；前端期望 3000，前     
端 .env 使用后端 5001。端口错配会导致测试挂起。
    - 测试流程仍以渐进模式（/story）为主；首页默认模式是“故事树”，因此“开始”后URL不匹配（预期 /story，实际 /story- 
tree）。- Playwright（生产）


    - playwright.prod.config.ts 使用 http://localhost:5001，更贴近部署；用例同样假设渐进模式。
- 建议
    - 统一本地端口：后端改回 5000 或测试跟随 5001；前端 .env 与 E2E基准一致。
    - 用例适配两种模式：在测试中显式切换“故事模式”或分别覆盖两个模式。
    - 增加后端最小单元测试（Jest）覆盖 storyService 的关键分支（正常、无Key、解析失败、数据库异常）。   

部署与文档

- Docker Compose
    - app 暴露 5000→宿主 5001 符合指南；健康检查与依赖关系（mongo）设置合理；可选 Nginx profile。       
- 文档偏差
    - README 与 docs/SETUP.md 仍大量描述 Supabase，已与代码（MongoDB）不符；新同学上手成本和环境误配风  
险高。
- 建议
    - 统一文档与现实：替换 Supabase 相关段落为 MongoDB 配置/运行说明；突出 .env 不应提交仓库。
                                                                                                           
安全与合规
                                                                                                           
- 高优先级问题
    - .env 与 .env.example 中含有真实 DEEPSEEK_API_KEY 已提交仓库，必须立即清除并“废弃/轮转”该密钥；改为
仅提供 .env.example（无真实值），并更新忽略规则。
- 其他
    - DeepSeek Key 打印首10位日志在生产环境也会输出，建议按 NODE_ENV 抑制（或彻底移除）。
    - 输入校验较完整，但可增加主题内容的更细致敏感词/不良语义过滤。
    - CORS 允许 http://localhost:3000 与配置 URL，安全范围可控；注意生产域名白名单。                     总

优先级改进清单（P0→P2）

- P0（阻断问题）
    - 移除仓库中的 .env 与敏感 Key，旋转密钥，更新 .gitignore 与 .env.example。
    - 修复故事树模式结束流程：EndPage 兼容树状态或新增 EndTreePage，并实现“保存故事”路径。
    - 统一本地端口与E2E预期（后端 5000/5001、前端 3000）；更新 Playwright 配置/用例，或在首页测试中先切 
换“渐进模式”再进入 /story。
    - 后端 dev 启动脚本修正：nodemon --exec ts-node src/index.ts 或直接 nodemon dist/index.js。
- P1（体验/一致性）
    - generatePreview 支持 fullStory 或 path[0].segment；MyStoriesPage 点击卡片请求详情并解析展示全文。 
    - Health 降级策略：DeepSeek 缺失不影响整体“healthy”，另在 payload 标注依赖状态。
    - 移除/修正 httpsAgent: false，避免潜在请求不稳定。
    - 去重类型定义：统一以 shared/types 为单一事实源。
- P2（增强/优化）
    - 后端增加删除接口与分页查询；前端补“删除故事”。
    - 加强输入过滤（敏感词、正则白名单等）和提示文案。
    - 单测覆盖 storyService 正常/异常/兜底路径；StoryTree 生成关键路径加断言（模拟DeepSeek）。    