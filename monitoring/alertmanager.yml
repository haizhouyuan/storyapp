# AlertManageré…ç½®æ–‡ä»¶
# StoryAppå‘Šè­¦ç®¡ç†é…ç½®

global:
  # å…¨å±€é…ç½®
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@storyapp.com'
  smtp_auth_username: 'alerts@storyapp.com'
  smtp_auth_password: '${SMTP_PASSWORD}'
  
  # ä¼ä¸šå¾®ä¿¡é…ç½®ï¼ˆå¯é€‰ï¼‰
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
  wechat_api_secret: '${WECHAT_API_SECRET}'
  wechat_api_corp_id: '${WECHAT_CORP_ID}'

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  
  routes:
    # å…³é”®å‘Šè­¦ç«‹å³å‘é€
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
    
    # ä¸šåŠ¡å‘Šè­¦
    - match:
        service: story-generation
      receiver: 'business-alerts'
      group_interval: 5m
      repeat_interval: 30m
    
    # åŸºç¡€è®¾æ–½å‘Šè­¦
    - match:
        service: infrastructure
      receiver: 'infrastructure-alerts'
      group_interval: 15m
      repeat_interval: 2h
    
    # å®‰å…¨å‘Šè­¦
    - match:
        service: security
      receiver: 'security-alerts'
      group_wait: 0s
      repeat_interval: 10m

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤webhook
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://webhook-server:8080/webhook'
        send_resolved: true

  # å…³é”®å‘Šè­¦ - å¤šæ¸ é“é€šçŸ¥
  - name: 'critical-alerts'
    email_configs:
      - to: 'ops-team@storyapp.com'
        subject: 'ğŸš¨ StoryApp Critical Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2>Critical Alert Fired</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Service:</strong> {{ .GroupLabels.service }}</p>
          <p><strong>Time:</strong> {{ .FiringAlerts | len }} firing, {{ .ResolvedAlerts | len }} resolved</p>
          
          {{ if .FiringAlerts }}
          <h3>Firing Alerts:</h3>
          <ul>
          {{ range .FiringAlerts }}
          <li>{{ .Annotations.summary }}: {{ .Annotations.description }}</li>
          {{ end }}
          </ul>
          {{ end }}
          
          {{ if .ResolvedAlerts }}
          <h3>Resolved Alerts:</h3>
          <ul>
          {{ range .ResolvedAlerts }}
          <li>{{ .Annotations.summary }}: {{ .Annotations.description }}</li>
          {{ end }}
          </ul>
          {{ end }}
    
    # Slacké€šçŸ¥ï¼ˆå¦‚æœé…ç½®ï¼‰
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-critical'
        title: 'StoryApp Critical Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}
        color: 'danger'
        send_resolved: true

    # ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆå¦‚æœé…ç½®ï¼‰
    wechat_configs:
      - corp_id: '${WECHAT_CORP_ID}'
        agent_id: '${WECHAT_AGENT_ID}'
        to_tag: 'ops-team'
        message: |
          ğŸš¨ StoryAppå…³é”®å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.service }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ä¸šåŠ¡å‘Šè­¦
  - name: 'business-alerts'
    email_configs:
      - to: 'product-team@storyapp.com'
        subject: 'ğŸ“Š StoryApp Business Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2>Business Metric Alert</h2>
          <p>æ£€æµ‹åˆ°ä¸šåŠ¡æŒ‡æ ‡å¼‚å¸¸ï¼Œè¯·åŠæ—¶å¤„ç†ã€‚</p>
          
          {{ range .Alerts }}
          <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
            <h3>{{ .Annotations.summary }}</h3>
            <p><strong>æè¿°:</strong> {{ .Annotations.description }}</p>
            <p><strong>æœåŠ¡:</strong> {{ .Labels.service }}</p>
            <p><strong>ä¸¥é‡ç¨‹åº¦:</strong> {{ .Labels.severity }}</p>
          </div>
          {{ end }}

  # åŸºç¡€è®¾æ–½å‘Šè­¦
  - name: 'infrastructure-alerts'
    email_configs:
      - to: 'devops-team@storyapp.com'
        subject: 'ğŸ”§ StoryApp Infrastructure Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2>Infrastructure Alert</h2>
          <p>æ£€æµ‹åˆ°åŸºç¡€è®¾æ–½é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ã€‚</p>
          
          {{ range .Alerts }}
          <div style="background-color: #f9f9f9; padding: 10px; margin: 10px 0;">
            <h4>{{ .Annotations.summary }}</h4>
            <p>{{ .Annotations.description }}</p>
            <p><small>Service: {{ .Labels.service }} | Time: {{ .StartsAt.Format "2006-01-02 15:04:05" }}</small></p>
          </div>
          {{ end }}

  # å®‰å…¨å‘Šè­¦
  - name: 'security-alerts'
    email_configs:
      - to: 'security-team@storyapp.com'
        subject: 'ğŸ”’ StoryApp Security Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: red;">Security Alert</h2>
          <p><strong>âš ï¸ æ£€æµ‹åˆ°å®‰å…¨ç›¸å…³äº‹ä»¶ï¼Œéœ€è¦ç«‹å³å…³æ³¨ï¼</strong></p>
          
          {{ range .Alerts }}
          <div style="border: 2px solid red; padding: 15px; margin: 10px 0; background-color: #ffe6e6;">
            <h3>{{ .Annotations.summary }}</h3>
            <p><strong>è¯¦æƒ…:</strong> {{ .Annotations.description }}</p>
            <p><strong>æ—¶é—´:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
            <p><strong>æœåŠ¡:</strong> {{ .Labels.service }}</p>
          </div>
          {{ end }}
          
          <p><strong>å»ºè®®æ“ä½œ:</strong></p>
          <ul>
            <li>ç«‹å³æ£€æŸ¥åº”ç”¨æ—¥å¿—</li>
            <li>æ£€æŸ¥è®¿é—®æ¨¡å¼æ˜¯å¦å¼‚å¸¸</li>
            <li>å¿…è¦æ—¶è€ƒè™‘ä¸´æ—¶é™åˆ¶è®¿é—®</li>
          </ul>
    
    # å®‰å…¨å‘Šè­¦ä¹Ÿå‘é€åˆ°Slack
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-security'
        title: 'ğŸ”’ Security Alert'
        text: |
          {{ range .Alerts }}
          *Security Event:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        color: 'danger'

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœ‰å…³é”®å‘Šè­¦ï¼ŒæŠ‘åˆ¶è­¦å‘Šçº§åˆ«çš„å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # å¦‚æœæœåŠ¡å®Œå…¨downï¼ŒæŠ‘åˆ¶ç›¸å…³çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: 'StoryAppServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['service']

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'