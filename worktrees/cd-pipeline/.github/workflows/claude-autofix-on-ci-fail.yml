name: ClaudeCode Autofix on CI failure

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  autofix:
    if: >
      ${{ github.event.workflow_run.conclusion == 'failure' &&
          github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}

    steps:
      - name: Find PR for failing run
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headBranch = run.head_branch;
            const { data: prs } = await github.rest.pulls.list({ owner, repo, head: `${owner}:${headBranch}`, state: 'open' });
            if (!prs || prs.length === 0) {
              core.setFailed(`No open PR found for branch ${headBranch}`);
              return;
            }
            const pr = prs[0];
            core.setOutput('number', pr.number.toString());
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('base_ref', pr.base.ref);

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Run Claude Code to autofix
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          track_progress: true
          prompt: |
            ä»»åŠ¡ï¼šé’ˆå¯¹å½“å‰ PR çš„ CI å¤±è´¥ï¼Œè¿›è¡Œâ€œæœ€å°å¯è¡Œä¿®æ”¹â€çš„è‡ªåŠ¨ä¿®å¤å¹¶æ¨å›åˆ°åŒä¸€åˆ†æ”¯ã€‚

            è¦æ±‚ï¼š
            - ä¼˜å…ˆä¿®å¤ç¼–è¯‘é”™è¯¯ã€ç±»å‹é”™è¯¯ã€å•å…ƒæµ‹è¯•å¤±è´¥ä¸æ˜æ˜¾çš„ ESLint/æ ¼å¼é—®é¢˜ã€‚
            - ä¸è¿›è¡Œå¤§èŒƒå›´é‡æ„ï¼›èšç„¦æ ¹å› ï¼Œå°½å¯èƒ½ä¿æŒæ”¹åŠ¨æœ€å°ã€‚
            - å¦‚éœ€æ”¹åŠ¨æµ‹è¯•ï¼Œè¯·ä¿è¯è¯­ä¹‰æ­£ç¡®ä¸”èƒ½ç¨³å®šé€šè¿‡ã€‚
            - æäº¤ä¿¡æ¯ä½¿ç”¨ï¼š"claude: autofix"ã€‚

            å‚è€ƒï¼š
            - é¡¹ç›®è„šæœ¬ï¼šæ ¹ package.json ä»¥åŠ backend/frontend ä¸‹çš„ build/test/lint ç›¸å…³è„šæœ¬ã€‚
            - è‹¥æœ‰å¿…è¦ï¼Œå¯åœ¨æœ¬åœ°å°è¯•è¿è¡Œ "npm run -w backend test" æˆ–ç›¸åº”æ„å»ºè„šæœ¬ä»¥éªŒè¯æ”¹åŠ¨æ€è·¯ï¼ˆè¯·æœ€å°åŒ–å°è¯•ï¼‰ã€‚

            è¾“å‡ºï¼š
            - ç›´æ¥åœ¨åˆ†æ”¯ä¸Šæäº¤ä¿®å¤ï¼›
            - åœ¨ PR ä¸­è´´å‡ºä¿®å¤æ‘˜è¦ï¼ˆå…³é”®æ–‡ä»¶/ä¿®æ”¹ç‚¹/åŸå› ï¼‰ã€‚

      - name: Fallback commit if changes staged but not committed
        run: |
          if ! git diff --quiet; then
            git config user.email "action@github.com"
            git config user.name "ClaudeCode Autofix"
            git add -A
            git commit -m "claude: autofix"
            git push
          fi

      - name: Post completion note
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.pr.outputs.number }}'),
              body: `ğŸ¤– ClaudeCode Autofix å·²æ‰§è¡Œã€‚çŠ¶æ€ï¼š${{ job.status }}ã€‚`
            });

