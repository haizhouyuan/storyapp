name: Production Monitoring

on:
  schedule:
    # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ç”Ÿäº§ç¯å¢ƒçŠ¶æ€
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: false
        default: 'health'
        type: choice
        options:
          - 'health'
          - 'performance'
          - 'security'
          - 'full'

jobs:
  health-check:
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'health' || github.event.inputs.check_type == 'full' || !github.event.inputs.check_type
    
    steps:
      - name: Application Health Check
        id: health
        run: |
          echo "ğŸ¥ æ‰§è¡Œåº”ç”¨å¥åº·æ£€æŸ¥..."
          
          HEALTH_STATUS="healthy"
          ISSUES=()
          
          # æ£€æŸ¥ä¸»è¦ç«¯ç‚¹
          ENDPOINTS=(
            "https://storyapp.dandanbaba.xyz/api/health"
            "https://storyapp.dandanbaba.xyz/healthz"
            "https://storyapp.dandanbaba.xyz"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            echo "æ£€æŸ¥: $endpoint"
            if ! curl -f -s --max-time 10 "$endpoint" > /dev/null; then
              echo "âŒ $endpoint ä¸å¯è®¿é—®"
              HEALTH_STATUS="unhealthy"
              ISSUES+=("$endpoint ä¸å¯è®¿é—®")
            else
              echo "âœ… $endpoint æ­£å¸¸"
            fi
          done
          
          # æ£€æŸ¥å“åº”æ—¶é—´
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://storyapp.dandanbaba.xyz/api/health || echo "999")
          if (( $(echo "$RESPONSE_TIME > 5.0" | bc -l) )); then
            echo "âš ï¸ å“åº”æ—¶é—´è¿‡é•¿: ${RESPONSE_TIME}s"
            HEALTH_STATUS="slow"
            ISSUES+=("å“åº”æ—¶é—´è¿‡é•¿: ${RESPONSE_TIME}s")
          else
            echo "âœ… å“åº”æ—¶é—´æ­£å¸¸: ${RESPONSE_TIME}s"
          fi
          
          echo "status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          printf 'issues=%s\n' "$(IFS=,; echo "${ISSUES[*]}")" >> $GITHUB_OUTPUT

      - name: Database Connectivity Check
        id: database
        run: |
          echo "ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
          
          # é€šè¿‡APIæ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
          if curl -f -s https://storyapp.dandanbaba.xyz/api/health | jq -e '.database.connected == true' > /dev/null; then
            echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
            echo "status=connected" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸"
            echo "status=disconnected" >> $GITHUB_OUTPUT
          fi

      - name: Generate Health Report
        if: always()
        run: |
          echo "## ğŸ¥ åº”ç”¨å¥åº·æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ£€æŸ¥æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åº”ç”¨çŠ¶æ€
          case "${{ steps.health.outputs.status }}" in
            "healthy")
              echo "**åº”ç”¨çŠ¶æ€:** âœ… å¥åº·" >> $GITHUB_STEP_SUMMARY
              ;;
            "slow")
              echo "**åº”ç”¨çŠ¶æ€:** âš ï¸ å“åº”ç¼“æ…¢" >> $GITHUB_STEP_SUMMARY
              ;;
            "unhealthy")
              echo "**åº”ç”¨çŠ¶æ€:** âŒ å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          
          # æ•°æ®åº“çŠ¶æ€
          if [ "${{ steps.database.outputs.status }}" == "connected" ]; then
            echo "**æ•°æ®åº“çŠ¶æ€:** âœ… è¿æ¥æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          else
            echo "**æ•°æ®åº“çŠ¶æ€:** âŒ è¿æ¥å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
          fi
          
          # é—®é¢˜è¯¦æƒ…
          if [ -n "${{ steps.health.outputs.issues }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**å‘ç°é—®é¢˜:**" >> $GITHUB_STEP_SUMMARY
            IFS=',' read -ra ISSUE_ARRAY <<< "${{ steps.health.outputs.issues }}"
            for issue in "${ISSUE_ARRAY[@]}"; do
              echo "- $issue" >> $GITHUB_STEP_SUMMARY
            done
          fi

  performance-check:
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'performance' || github.event.inputs.check_type == 'full'
    
    steps:
      - name: Performance Metrics Collection
        id: performance
        run: |
          echo "ğŸ“Š æ”¶é›†æ€§èƒ½æŒ‡æ ‡..."
          
          # æ£€æŸ¥å“åº”æ—¶é—´
          declare -A endpoints=(
            ["ä¸»é¡µ"]="https://storyapp.dandanbaba.xyz"
            ["å¥åº·æ£€æŸ¥"]="https://storyapp.dandanbaba.xyz/api/health"
            ["APIç«¯ç‚¹"]="https://storyapp.dandanbaba.xyz/healthz"
          )
          
          echo "## å“åº”æ—¶é—´æµ‹è¯•" >> /tmp/performance.txt
          for name in "${!endpoints[@]}"; do
            url="${endpoints[$name]}"
            time=$(curl -o /dev/null -s -w '%{time_total}' "$url" || echo "999")
            echo "$name: ${time}s" >> /tmp/performance.txt
            
            if (( $(echo "$time > 3.0" | bc -l) )); then
              echo "âš ï¸ $name å“åº”æ—¶é—´è¿‡é•¿: ${time}s"
            else
              echo "âœ… $name å“åº”æ—¶é—´æ­£å¸¸: ${time}s"
            fi
          done
          
          # æ£€æŸ¥å¯ç”¨æ€§
          UPTIME_START=$(date +%s)
          for i in {1..5}; do
            if curl -f -s https://storyapp.dandanbaba.xyz/api/health > /dev/null; then
              echo "âœ… å¯ç”¨æ€§æ£€æŸ¥ $i/5 é€šè¿‡"
            else
              echo "âŒ å¯ç”¨æ€§æ£€æŸ¥ $i/5 å¤±è´¥"
            fi
            sleep 2
          done
          UPTIME_END=$(date +%s)
          
          echo "å¯ç”¨æ€§æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: $((UPTIME_END - UPTIME_START))ç§’" >> /tmp/performance.txt

      - name: Upload Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report-${{ github.run_number }}
          path: /tmp/performance.txt

  alert:
    runs-on: ubuntu-latest
    needs: [health-check, performance-check]
    if: always() && (needs.health-check.outputs.status == 'unhealthy' || needs.database-check.outputs.status == 'disconnected')
    
    steps:
      - name: Send Alert Notification
        run: |
          echo "ğŸš¨ å‘é€å‘Šè­¦é€šçŸ¥..."
          
          # æ„å»ºå‘Šè­¦æ¶ˆæ¯
          ALERT_MESSAGE="ğŸš¨ StoryApp ç”Ÿäº§ç¯å¢ƒå‘Šè­¦"
          ALERT_MESSAGE="$ALERT_MESSAGE\næ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          
          if [ "${{ needs.health-check.outputs.status }}" == "unhealthy" ]; then
            ALERT_MESSAGE="$ALERT_MESSAGE\nâŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
          fi
          
          if [ "${{ needs.database-check.outputs.status }}" == "disconnected" ]; then
            ALERT_MESSAGE="$ALERT_MESSAGE\nâŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸"
          fi
          
          ALERT_MESSAGE="$ALERT_MESSAGE\n\nè¯·ç«‹å³æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒçŠ¶æ€"
          ALERT_MESSAGE="$ALERT_MESSAGE\nğŸ”— ç›‘æ§é¢æ¿: https://github.com/${{ github.repository }}/actions"
          
          echo -e "$ALERT_MESSAGE"
          
          # è¿™é‡Œå¯ä»¥é›†æˆ Slackã€Discordã€é‚®ä»¶ç­‰é€šçŸ¥æ–¹å¼
          # ç¤ºä¾‹ï¼šSlack Webhook
          # curl -X POST -H 'Content-type: application/json' \
          #   --data "{\"text\":\"$ALERT_MESSAGE\"}" \
          #   "${{ secrets.SLACK_WEBHOOK_URL }}"

  cleanup:
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'full'
    
    steps:
      - name: Cleanup Old Artifacts
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§çš„ç›‘æ§æ•°æ®..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘ï¼Œæ¯”å¦‚åˆ é™¤æ—§çš„æ€§èƒ½æŠ¥å‘Šç­‰
          echo "æ¸…ç†å®Œæˆ"