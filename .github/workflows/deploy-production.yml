name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'éƒ¨ç½²çš„é•œåƒæ ‡ç­¾'
        required: false
        default: 'main'
        type: choice
        options:
          - 'main'
          - 'latest'
          - 'master'
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½²ï¼ˆè·³è¿‡å¥åº·æ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean
      rollback_on_failure:
        description: 'å¤±è´¥æ—¶è‡ªåŠ¨å›žæ»š'
        required: false
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  pre-deploy-checks:
    runs-on: ubuntu-latest
    environment: production
    
    outputs:
      deploy_ready: ${{ steps.checks.outputs.ready }}
      image_exists: ${{ steps.image_check.outputs.exists }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if image exists
        id: image_check
        run: |
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          IMAGE_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          
          echo "æ£€æŸ¥é•œåƒ: $IMAGE_URL"
          
          # ç™»å½•GHCR
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          if docker manifest inspect $IMAGE_URL > /dev/null 2>&1; then
            echo "âœ… é•œåƒå­˜åœ¨: $IMAGE_URL"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ é•œåƒä¸å­˜åœ¨: $IMAGE_URL"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Pre-deployment checks
        id: checks
        run: |
          echo "ðŸ” æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
          
          # æ£€æŸ¥è¾“å…¥å‚æ•°
          if [[ -z "${{ github.event.inputs.image_tag }}" ]]; then
            echo "âŒ é•œåƒæ ‡ç­¾ä¸èƒ½ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"
          echo "ready=true" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    environment: production
    if: needs.pre-deploy-checks.outputs.deploy_ready == 'true' && needs.pre-deploy-checks.outputs.image_exists == 'true'
    
    steps:
      - name: Deploy to Production Server
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          timeout: 300s
          command_timeout: 300s
          script: |
            set -e
            
            echo "ðŸš€ å¼€å§‹éƒ¨ç½² StoryApp åˆ°ç”Ÿäº§çŽ¯å¢ƒ"
            echo "ðŸ“¦ é•œåƒæ ‡ç­¾: ${{ github.event.inputs.image_tag }}"
            echo "ðŸ•’ éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            
            # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
            cd /root/projects/storyapp || { echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }
            
            # è®°å½•å½“å‰è¿è¡Œçš„å®¹å™¨ä¿¡æ¯ï¼ˆç”¨äºŽå›žæ»šï¼‰
            echo "ðŸ“‹ è®°å½•å½“å‰éƒ¨ç½²çŠ¶æ€..."
            docker compose ps > /tmp/storyapp_pre_deploy_status.txt
            docker images | grep storyapp > /tmp/storyapp_pre_deploy_images.txt || true
            
            # æ›´æ–°ä»£ç 
            echo "ðŸ“¥ æ›´æ–°ä»£ç ..."
            git fetch --all
            git pull gitee master || git pull gitee main
            
            # è®¾ç½®é•œåƒæ ‡ç­¾
            export APP_TAG="${{ github.event.inputs.image_tag }}"
            echo "ðŸ·ï¸  è®¾ç½®é•œåƒæ ‡ç­¾: $APP_TAG"
            
            # ç™»å½•GHCR
            echo "ðŸ” ç™»å½•å®¹å™¨é•œåƒä»“åº“..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # æ‹‰å–æ–°é•œåƒ
            IMAGE_URL="ghcr.io/${{ github.repository }}:${APP_TAG}"
            echo "ðŸ“¦ æ‹‰å–é•œåƒ: $IMAGE_URL"
            docker pull $IMAGE_URL
            
            # åœæ­¢æ—§æœåŠ¡ï¼ˆä¿ç•™æ•°æ®åº“ï¼‰
            echo "â¹ï¸  åœæ­¢åº”ç”¨æœåŠ¡..."
            docker compose stop app || true
            
            # å¤‡ä»½å½“å‰çŽ¯å¢ƒæ–‡ä»¶
            cp .env .env.backup.$(date +%Y%m%d_%H%M%S) || true
            
            # æ›´æ–°docker-composeé…ç½®ä½¿ç”¨æ–°é•œåƒ
            echo "ðŸ”§ æ›´æ–°å®¹å™¨é…ç½®..."
            export DOCKER_IMAGE="$IMAGE_URL"
            
            # å¯åŠ¨æ–°æœåŠ¡
            echo "ðŸš€ å¯åŠ¨æ–°ç‰ˆæœ¬..."
            docker compose up -d app
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # å¥åº·æ£€æŸ¥
            echo "ðŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..5}; do
              if curl -f -s http://localhost:5001/api/health > /dev/null; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (å°è¯• $i)"
                break
              elif [ $i -eq 5 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå‡†å¤‡å›žæ»š..."
                exit 1
              else
                echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…é‡è¯•... (å°è¯• $i)"
                sleep 10
              fi
            done
            
            # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬ï¼‰
            echo "ðŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker images --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | \
              grep "ghcr.io/${{ github.repository }}" | \
              tail -n +4 | \
              awk '{print $1}' | \
              xargs -r docker rmi || true
            
            echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "ðŸŒ åº”ç”¨åœ°å€: https://storyapp.dandanbaba.xyz"

      - name: Post-deployment verification
        if: steps.deploy.outcome == 'success'
        run: |
          echo "ðŸ” æ‰§è¡Œéƒ¨ç½²åŽéªŒè¯..."
          
          # ç­‰å¾…DNSä¼ æ’­
          sleep 30
          
          # éªŒè¯ç”Ÿäº§çŽ¯å¢ƒ
          for endpoint in "/api/health" "/healthz"; do
            echo "æ£€æŸ¥ç«¯ç‚¹: $endpoint"
            if curl -f -s https://storyapp.dandanbaba.xyz$endpoint; then
              echo "âœ… $endpoint æ­£å¸¸"
            else
              echo "âš ï¸ $endpoint æ£€æŸ¥å¤±è´¥ï¼Œä½†ä¸é˜»æ­¢éƒ¨ç½²"
            fi
          done

      - name: Rollback on failure
        if: failure() && github.event.inputs.rollback_on_failure == 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            echo "ðŸ”„ æ‰§è¡Œè‡ªåŠ¨å›žæ»š..."
            cd /root/projects/storyapp
            
            # æ¢å¤ä¹‹å‰çš„çŠ¶æ€
            if [ -f /tmp/storyapp_pre_deploy_status.txt ]; then
              echo "ðŸ“‹ æ¢å¤ä¹‹å‰çš„éƒ¨ç½²çŠ¶æ€..."
              docker compose down app || true
              docker compose up -d app
              
              # ç®€å•å¥åº·æ£€æŸ¥
              sleep 10
              if curl -f -s http://localhost:5001/api/health; then
                echo "âœ… å›žæ»šæˆåŠŸ"
              else
                echo "âŒ å›žæ»šå¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
              fi
            else
              echo "âš ï¸ æ— æ³•æ‰¾åˆ°ä¹‹å‰çš„çŠ¶æ€ï¼Œè·³è¿‡è‡ªåŠ¨å›žæ»š"
            fi

  notify:
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy]
    if: always()
    
    steps:
      - name: Generate deployment summary
        run: |
          echo "## ðŸš€ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:** \`${{ github.event.inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²ç”¨æˆ·:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "**çŠ¶æ€:** âœ… éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "**åº”ç”¨åœ°å€:** https://storyapp.dandanbaba.xyz" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€:** âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "**å›žæ»šçŠ¶æ€:** ${{ github.event.inputs.rollback_on_failure && 'å·²æ‰§è¡Œè‡ªåŠ¨å›žæ»š' || 'æœªæ‰§è¡Œè‡ªåŠ¨å›žæ»š' }}" >> $GITHUB_STEP_SUMMARY
          fi