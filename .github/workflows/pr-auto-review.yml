name: PR Auto Review with Claude

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master, main]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  # ä¸»è¦çš„ä»£ç è¯„å®¡ä»»åŠ¡
  claude-review:
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    timeout-minutes: 15
    
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
    
    outputs:
      review_completed: ${{ steps.claude_review.outputs.completed }}
      review_status: ${{ steps.claude_review.outputs.status }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto Review PR with Claude
        id: claude_review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          track_progress: true
          prompt: |
            è¯·å¯¹è¿™ä¸ªPRè¿›è¡Œå…¨é¢çš„ä»£ç è¯„å®¡ã€‚é‡ç‚¹å…³æ³¨ï¼š
            
            ## è¯„å®¡è¦ç‚¹
            1. **ä»£ç è´¨é‡**ï¼šä»£ç ç»“æ„ã€å¯è¯»æ€§ã€æœ€ä½³å®è·µ
            2. **å®‰å…¨æ€§**ï¼šæ½œåœ¨çš„å®‰å…¨æ¼æ´å’Œé£é™©  
            3. **æ€§èƒ½**ï¼šæ€§èƒ½é—®é¢˜å’Œä¼˜åŒ–å»ºè®®
            4. **æµ‹è¯•**ï¼šæµ‹è¯•è¦†ç›–åº¦å’Œæµ‹è¯•è´¨é‡
            5. **å„¿ç«¥åº”ç”¨ç‰¹æ®Šè¦æ±‚**ï¼š
               - COPPAåˆè§„æ€§ï¼ˆå„¿ç«¥éšç§ä¿æŠ¤ï¼‰
               - å†…å®¹å®‰å…¨æ€§å’Œè¿‡æ»¤
               - ç”¨æˆ·ä½“éªŒå‹å¥½æ€§
            6. **é¡¹ç›®ç‰¹å®šæ£€æŸ¥**ï¼š
               - StoryAppåŠŸèƒ½å®Œæ•´æ€§
               - APIæ¥å£å®‰å…¨æ€§
               - MongoDBæŸ¥è¯¢ä¼˜åŒ–
               - Reactç»„ä»¶æœ€ä½³å®è·µ
            
            ## è¯„å®¡æ ¼å¼ï¼ˆå¿…é¡»ä¸¥æ ¼éµå¾ªï¼‰
            ### ğŸ“‹ ä»£ç è¯„å®¡æŠ¥å‘Š
            
            **PRæ¦‚è¿°**: [ç®€è¦æè¿°PRçš„ä¸»è¦å˜æ›´]
            
            **ğŸ” è¯¦ç»†è¯„å®¡**:
            
            #### ğŸ”´ ä¸¥é‡é—®é¢˜
            [åˆ—å‡ºå¿…é¡»ä¿®å¤çš„é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™å†™"æ— "]
            
            #### ğŸŸ¡ å»ºè®®æ”¹è¿›
            [åˆ—å‡ºå»ºè®®æ”¹è¿›çš„åœ°æ–¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™å†™"æ— "]
            
            #### ğŸŸ¢ è‰¯å¥½å®è·µ
            [åˆ—å‡ºåšå¾—å¥½çš„åœ°æ–¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™å†™"æ— "]
            
            **ğŸ“Š è¯„å®¡è¯„åˆ†**: X/10 åˆ†
            **âœ… å»ºè®®çŠ¶æ€**: [æ‰¹å‡†/éœ€è¦ä¿®æ”¹/æ‹’ç»]
            **ğŸ’¬ æ€»ä½“å»ºè®®**: [æ€»ç»“æ€§å»ºè®®]
            
            ---
            *ğŸ¤– æœ¬è¯„å®¡ç”±Claude Codeè‡ªåŠ¨ç”Ÿæˆ | æ—¶é—´: $(date)*
            
            ## è¾“å‡ºè¦æ±‚
            - å¿…é¡»ä½¿ç”¨ä¸Šè¿°æ ¼å¼æ¨¡æ¿
            - æ¯ä¸ªéƒ¨åˆ†éƒ½å¿…é¡»å¡«å†™ï¼Œå³ä½¿æ˜¯"æ— "
            - æä¾›å…·ä½“çš„æ–‡ä»¶åå’Œè¡Œå·
            - ç»™å‡ºä»£ç æ”¹è¿›ç¤ºä¾‹
            - è¯„åˆ†å¿…é¡»åŸºäºå®é™…å‘ç°çš„é—®é¢˜
            
            **é‡è¦**: æ— è®ºè¯„å®¡ç»“æœå¦‚ä½•ï¼Œéƒ½å¿…é¡»åœ¨PRä¸­ç•™ä¸‹è¯„è®ºã€‚

      - name: Set review completion flag
        if: always()
        run: |
          echo "completed=true" >> $GITHUB_OUTPUT
          echo "status=${{ job.status }}" >> $GITHUB_OUTPUT

  # ç¡®ä¿å›å¸–çš„å®ˆæŠ¤ä»»åŠ¡
  ensure-response:
    runs-on: ubuntu-latest
    needs: claude-review
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Check if review was posted
        id: check_review
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComments = comments.filter(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“‹ ä»£ç è¯„å®¡æŠ¥å‘Š')
            );
            
            console.log(`Found ${botComments.length} bot review comments`);
            return botComments.length > 0;

      - name: Post fallback response if needed
        if: steps.check_review.outputs.result == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fallbackMessage = `### ğŸ“‹ ä»£ç è¯„å®¡æŠ¥å‘Š
            
            **PRæ¦‚è¿°**: è‡ªåŠ¨ä»£ç è¯„å®¡
            
            **ğŸ¤– è¯„å®¡çŠ¶æ€**: è¯„å®¡æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œä½†æˆ‘ä»¬å·²æ”¶åˆ°æ‚¨çš„PRæäº¤ã€‚
            
            **ğŸ” åŸºç¡€æ£€æŸ¥**:
            - âœ… PRå·²æˆåŠŸæäº¤
            - â³ ç­‰å¾…äººå·¥è¯„å®¡
            
            **ğŸ“Š åç»­æ­¥éª¤**:
            1. è¯·ç¡®ä¿ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
            2. è¿è¡Œæœ¬åœ°æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
            3. ç­‰å¾…ç»´æŠ¤è€…äººå·¥å®¡æ ¸
            
            **ğŸ’¬ è¯´æ˜**: æœ¬æ¬¡è‡ªåŠ¨è¯„å®¡é‡åˆ°æŠ€æœ¯é—®é¢˜ï¼Œå°†å®‰æ’äººå·¥è¯„å®¡ã€‚æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼
            
            ---
            *ğŸ› ï¸ å¤‡ç”¨è¯„å®¡ç³»ç»Ÿ | æ—¶é—´: ${new Date().toISOString()}*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: fallbackMessage
            });

  # è¯„å®¡çŠ¶æ€æ€»ç»“ä»»åŠ¡
  review-summary:
    runs-on: ubuntu-latest
    needs: [claude-review, ensure-response]
    if: always()
    timeout-minutes: 3
    
    steps:
      - name: Update PR status
        uses: actions/github-script@v7
        with:
          script: |
            const reviewStatus = '${{ needs.claude-review.result }}';
            const fallbackStatus = '${{ needs.ensure-response.result }}';
            
            let statusEmoji = 'âœ…';
            let statusMessage = 'Code review completed successfully';
            
            if (reviewStatus === 'failure') {
              statusEmoji = 'âš ï¸';
              statusMessage = 'Code review completed with fallback system';
            } else if (reviewStatus === 'cancelled') {
              statusEmoji = 'ğŸš«';
              statusMessage = 'Code review was cancelled';
            }
            
            console.log(`${statusEmoji} ${statusMessage}`);
            console.log(`Review job status: ${reviewStatus}`);
            console.log(`Fallback job status: ${fallbackStatus}`);
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šçš„çŠ¶æ€å¤„ç†é€»è¾‘
            // æ¯”å¦‚è®¾ç½®PR labelsã€å‘é€é€šçŸ¥ç­‰
