name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      rollback_tag:
        description: 'å›žæ»šåˆ°çš„é•œåƒæ ‡ç­¾'
        required: true
        type: string
      rollback_reason:
        description: 'å›žæ»šåŽŸå› '
        required: true
        type: choice
        options:
          - 'critical_bug'
          - 'performance_issue'
          - 'security_vulnerability'
          - 'feature_rollback'
          - 'other'
      confirm_rollback:
        description: 'ç¡®è®¤æ‰§è¡Œå›žæ»š (è¾“å…¥ CONFIRM)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-rollback:
    runs-on: ubuntu-latest
    environment: production
    
    outputs:
      rollback_approved: ${{ steps.validation.outputs.approved }}
      target_image: ${{ steps.validation.outputs.target_image }}
      
    steps:
      - name: Validate rollback request
        id: validation
        run: |
          echo "ðŸ” éªŒè¯å›žæ»šè¯·æ±‚..."
          
          # éªŒè¯ç¡®è®¤è¾“å…¥
          if [ "${{ github.event.inputs.confirm_rollback }}" != "CONFIRM" ]; then
            echo "âŒ å›žæ»šç¡®è®¤å¤±è´¥ï¼Œå¿…é¡»è¾“å…¥ CONFIRM"
            exit 1
          fi
          
          # æž„å»ºç›®æ ‡é•œåƒè·¯å¾„
          TARGET_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.rollback_tag }}"
          echo "target_image=$TARGET_IMAGE" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          if docker manifest inspect $TARGET_IMAGE > /dev/null 2>&1; then
            echo "âœ… ç›®æ ‡é•œåƒå­˜åœ¨: $TARGET_IMAGE"
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç›®æ ‡é•œåƒä¸å­˜åœ¨: $TARGET_IMAGE"
            echo "approved=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ðŸ“‹ å›žæ»šä¿¡æ¯:"
          echo "- ç›®æ ‡æ ‡ç­¾: ${{ github.event.inputs.rollback_tag }}"
          echo "- å›žæ»šåŽŸå› : ${{ github.event.inputs.rollback_reason }}"
          echo "- æ“ä½œç”¨æˆ·: ${{ github.actor }}"
          echo "- æ“ä½œæ—¶é—´: $(date)"

  rollback:
    runs-on: ubuntu-latest
    needs: validate-rollback
    environment: production
    if: needs.validate-rollback.outputs.rollback_approved == 'true'
    
    steps:
      - name: Execute rollback
        id: rollback
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          timeout: 300s
          script: |
            set -e
            
            echo "ðŸ”„ å¼€å§‹æ‰§è¡Œç”Ÿäº§çŽ¯å¢ƒå›žæ»š"
            echo "ðŸ“¦ ç›®æ ‡é•œåƒ: ${{ needs.validate-rollback.outputs.target_image }}"
            echo "ðŸŽ¯ å›žæ»šåŽŸå› : ${{ github.event.inputs.rollback_reason }}"
            echo "ðŸ‘¤ æ“ä½œç”¨æˆ·: ${{ github.actor }}"
            echo "ðŸ•’ å›žæ»šæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            
            # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
            cd /root/projects/storyapp || { echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }
            
            # å¤‡ä»½å½“å‰çŠ¶æ€
            echo "ðŸ’¾ å¤‡ä»½å½“å‰éƒ¨ç½²çŠ¶æ€..."
            mkdir -p /root/backups/rollback/$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="/root/backups/rollback/$(date +%Y%m%d_%H%M%S)"
            
            # è®°å½•å½“å‰å®¹å™¨çŠ¶æ€
            docker compose ps > "$BACKUP_DIR/pre_rollback_status.txt"
            docker images | grep storyapp > "$BACKUP_DIR/pre_rollback_images.txt" || true
            cp .env "$BACKUP_DIR/pre_rollback_env" || true
            
            # èŽ·å–å½“å‰è¿è¡Œçš„é•œåƒä¿¡æ¯
            CURRENT_IMAGE=$(docker inspect storyapp-app 2>/dev/null | jq -r '.[0].Config.Image' || echo "unknown")
            echo "ðŸ“‹ å½“å‰é•œåƒ: $CURRENT_IMAGE" | tee "$BACKUP_DIR/current_image.txt"
            
            # ç™»å½• GHCR
            echo "ðŸ” ç™»å½•å®¹å™¨é•œåƒä»“åº“..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # æ‹‰å–å›žæ»šç›®æ ‡é•œåƒ
            echo "ðŸ“¦ æ‹‰å–å›žæ»šç›®æ ‡é•œåƒ..."
            docker pull ${{ needs.validate-rollback.outputs.target_image }}
            
            # åœæ­¢å½“å‰åº”ç”¨æœåŠ¡
            echo "â¹ï¸  åœæ­¢å½“å‰åº”ç”¨æœåŠ¡..."
            docker compose stop app || true
            
            # æ›´æ–°é•œåƒæ ‡ç­¾
            export DOCKER_IMAGE="${{ needs.validate-rollback.outputs.target_image }}"
            echo "ðŸ·ï¸  è®¾ç½®å›žæ»šé•œåƒ: $DOCKER_IMAGE"
            
            # å¯åŠ¨å›žæ»šç‰ˆæœ¬
            echo "ðŸš€ å¯åŠ¨å›žæ»šç‰ˆæœ¬..."
            docker compose up -d app
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 20
            
            # å¥åº·æ£€æŸ¥
            echo "ðŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            HEALTH_CHECK_PASSED=false
            for i in {1..6}; do
              if curl -f -s http://localhost:5001/api/health > /dev/null; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (å°è¯• $i)"
                HEALTH_CHECK_PASSED=true
                break
              else
                echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…é‡è¯•... (å°è¯• $i/6)"
                sleep 15
              fi
            done
            
            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "âŒ å›žæ»šåŽå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå°è¯•æ¢å¤ä¹‹å‰çŠ¶æ€..."
              export DOCKER_IMAGE="$CURRENT_IMAGE"
              docker compose up -d app
              sleep 15
              if curl -f -s http://localhost:5001/api/health > /dev/null; then
                echo "ðŸ”„ å·²æ¢å¤åˆ°ä¹‹å‰çŠ¶æ€"
              else
                echo "ðŸ’¥ ä¸¥é‡é”™è¯¯ï¼šæ— æ³•æ¢å¤ï¼Œéœ€è¦ç´§æ€¥æ‰‹åŠ¨å¤„ç†ï¼"
                exit 1
              fi
              exit 1
            fi
            
            # è®°å½•å›žæ»šæˆåŠŸä¿¡æ¯
            echo "âœ… å›žæ»šæˆåŠŸå®Œæˆ" | tee "$BACKUP_DIR/rollback_success.txt"
            echo "å›žæ»šå‰é•œåƒ: $CURRENT_IMAGE" >> "$BACKUP_DIR/rollback_success.txt"
            echo "å›žæ»šåŽé•œåƒ: ${{ needs.validate-rollback.outputs.target_image }}" >> "$BACKUP_DIR/rollback_success.txt"
            echo "å›žæ»šæ—¶é—´: $(date)" >> "$BACKUP_DIR/rollback_success.txt"
            echo "æ“ä½œç”¨æˆ·: ${{ github.actor }}" >> "$BACKUP_DIR/rollback_success.txt"
            echo "å›žæ»šåŽŸå› : ${{ github.event.inputs.rollback_reason }}" >> "$BACKUP_DIR/rollback_success.txt"
            
            echo "ðŸŽ‰ å›žæ»šå®Œæˆï¼"
            echo "ðŸŒ åº”ç”¨åœ°å€: https://storyapp.dandanbaba.xyz"
            echo "ðŸ’¾ å¤‡ä»½ç›®å½•: $BACKUP_DIR"

      - name: Post-rollback verification
        if: steps.rollback.outcome == 'success'
        run: |
          echo "ðŸ” æ‰§è¡Œå›žæ»šåŽéªŒè¯..."
          
          # ç­‰å¾…DNSä¼ æ’­å’ŒæœåŠ¡ç¨³å®š
          sleep 60
          
          # éªŒè¯ç”Ÿäº§çŽ¯å¢ƒ
          VERIFICATION_PASSED=true
          for endpoint in "/api/health" "/healthz"; do
            echo "æ£€æŸ¥ç«¯ç‚¹: $endpoint"
            if curl -f -s https://storyapp.dandanbaba.xyz$endpoint; then
              echo "âœ… $endpoint æ­£å¸¸"
            else
              echo "âŒ $endpoint æ£€æŸ¥å¤±è´¥"
              VERIFICATION_PASSED=false
            fi
          done
          
          if [ "$VERIFICATION_PASSED" = false ]; then
            echo "âš ï¸ éƒ¨åˆ†éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨çŠ¶æ€"
            exit 1
          fi
          
          echo "âœ… å›žæ»šéªŒè¯å…¨éƒ¨é€šè¿‡"

  notify:
    runs-on: ubuntu-latest
    needs: [validate-rollback, rollback]
    if: always()
    
    steps:
      - name: Generate rollback summary
        run: |
          echo "## ðŸ”„ ç”Ÿäº§çŽ¯å¢ƒå›žæ»šæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å›žæ»šæ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ç›®æ ‡é•œåƒ:** \`${{ github.event.inputs.rollback_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**å›žæ»šåŽŸå› :** ${{ github.event.inputs.rollback_reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ“ä½œç”¨æˆ·:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.rollback.result }}" == "success" ]; then
            echo "**çŠ¶æ€:** âœ… å›žæ»šæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "**åº”ç”¨åœ°å€:** https://storyapp.dandanbaba.xyz" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> âš ï¸ **é‡è¦æé†’:** è¯·åŠæ—¶åˆ†æžå¹¶ä¿®å¤å¯¼è‡´å›žæ»šçš„é—®é¢˜ï¼Œé¿å…å†æ¬¡å‘ç”Ÿã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€:** âŒ å›žæ»šå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ðŸš¨ **ç´§æ€¥:** å›žæ»šå¤±è´¥ï¼Œéœ€è¦ç«‹å³æ‰‹åŠ¨å¤„ç†ç”Ÿäº§çŽ¯å¢ƒé—®é¢˜ï¼" >> $GITHUB_STEP_SUMMARY
          fi