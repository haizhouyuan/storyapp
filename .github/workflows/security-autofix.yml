name: Security Auto-Fix

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹
  workflow_dispatch:
    inputs:
      force_fix:
        description: 'å¼ºåˆ¶ä¿®å¤æ‰€æœ‰æ¼æ´'
        required: false
        default: false
        type: boolean
      severity_threshold:
        description: 'ä¿®å¤ä¸¥é‡çº§åˆ«é˜ˆå€¼'
        required: false
        default: 'moderate'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical

env:
  MAX_SEVERITY: ${{ inputs.force_fix && 'low' || inputs.severity_threshold || 'moderate' }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    outputs:
      vulnerabilities_found: ${{ steps.audit.outputs.vulnerabilities }}
      fix_strategy: ${{ steps.strategy.outputs.strategy }}
      scan_report: ${{ steps.audit.outputs.report_file }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci --legacy-peer-deps

      - name: Security Audit
        id: audit
        run: |
          echo "=== æ‰§è¡Œå®‰å…¨å®¡è®¡ ==="

          # åˆ›å»ºå®¡è®¡æŠ¥å‘Šç›®å½•
          mkdir -p security-reports

          # æ‰§è¡Œæ ¹é¡¹ç›®å®¡è®¡
          echo "æ‰«ææ ¹é¡¹ç›®..."
          npm audit --json > security-reports/root-audit.json || true

          # æ‰§è¡Œåç«¯é¡¹ç›®å®¡è®¡
          echo "æ‰«æåç«¯é¡¹ç›®..."
          cd backend
          npm audit --json > ../security-reports/backend-audit.json || true
          cd ..

          # æ‰§è¡Œå‰ç«¯é¡¹ç›®å®¡è®¡
          echo "æ‰«æå‰ç«¯é¡¹ç›®..."
          cd frontend
          npm audit --json > ../security-reports/frontend-audit.json || true
          cd ..

          # åˆå¹¶å®¡è®¡ç»“æœ
          python3 scripts/consolidate-audit-reports.py

          # è¯»å–æ¼æ´ç»Ÿè®¡
          VULN_COUNT=$(python3 -c 'import json; data=json.load(open("security-reports/consolidated-audit.json")); print(data["metadata"]["vulnerabilities"]["total"])' 2>/dev/null || echo "0")

          echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "report_file=security-reports/consolidated-audit.json" >> $GITHUB_OUTPUT

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "ğŸ” å‘ç° $VULN_COUNT ä¸ªå®‰å…¨æ¼æ´"

            # æå–æ¼æ´è¯¦æƒ…ç”¨äºç­–ç•¥ç”Ÿæˆ
            python3 scripts/consolidate-audit-reports.py extract
          else
            echo "âœ… æœªå‘ç°å®‰å…¨æ¼æ´"
          fi

      - name: Generate Fix Strategy
        id: strategy
        if: steps.audit.outputs.vulnerabilities > 0
        run: |
          echo "=== ç”Ÿæˆä¿®å¤ç­–ç•¥ ==="

          python3 scripts/security-fix-planner.py \
            --vulnerabilities="security-reports/vulnerabilities.json" \
            --max-severity="${{ env.MAX_SEVERITY }}" \
            --output="security-reports/fix-plan.json" \
            --consolidated-audit="security-reports/consolidated-audit.json"

          if [ -f "security-reports/fix-plan.json" ]; then
            STRATEGY=$(python3 -c 'import json; print(json.load(open("security-reports/fix-plan.json")).get("strategy", "auto_fix"))' 2>/dev/null || echo "manual_review")
            echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ ç”Ÿæˆçš„ä¿®å¤ç­–ç•¥: $STRATEGY"
          else
            echo "strategy=manual_review" >> $GITHUB_OUTPUT
            echo "âš ï¸  æ— æ³•ç”Ÿæˆä¿®å¤ç­–ç•¥ï¼Œå›é€€åˆ°äººå·¥å®¡æŸ¥"
          fi

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports/
          retention-days: 30

  automated-fix:
    needs: security-scan
    if: needs.security-scan.outputs.vulnerabilities_found > 0
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.email "security-autofix@github.actions"
          git config --global user.name "Security AutoFix Bot"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Download Security Reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports/

      - name: Install Dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci --legacy-peer-deps

      - name: Apply Security Fixes
        id: apply_fixes
        run: |
          echo "=== åº”ç”¨å®‰å…¨ä¿®å¤ ==="

          # åˆ›å»ºä¿®å¤åˆ†æ”¯
          BRANCH_NAME="security-fix/auto-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

          # å¤‡ä»½å…³é”®æ–‡ä»¶
          cp package.json package.json.backup
          cp package-lock.json package-lock.json.backup 2>/dev/null || true
          [ -f backend/package.json ] && cp backend/package.json backend/package.json.backup
          [ -f backend/package-lock.json ] && cp backend/package-lock.json backend/package-lock.json.backup
          [ -f frontend/package.json ] && cp frontend/package.json frontend/package.json.backup
          [ -f frontend/package-lock.json ] && cp frontend/package-lock.json frontend/package-lock.json.backup

          # æ‰§è¡Œä¿®å¤
          FIX_SUCCESS=false

          case "${{ needs.security-scan.outputs.fix_strategy }}" in
            "auto_fix")
              echo "ğŸ”§ æ‰§è¡Œè‡ªåŠ¨ä¿®å¤..."

              # å°è¯•è‡ªåŠ¨ä¿®å¤
              npm audit fix --force || echo "æ ¹é¡¹ç›®ä¿®å¤å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"

              cd backend
              npm audit fix --force || echo "åç«¯é¡¹ç›®ä¿®å¤å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"
              cd ..

              cd frontend
              npm audit fix --force || echo "å‰ç«¯é¡¹ç›®ä¿®å¤å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"
              cd ..

              FIX_SUCCESS=true
              ;;

            "selective_fix")
              echo "ğŸ¯ æ‰§è¡Œé€‰æ‹©æ€§ä¿®å¤..."

              # åªä¿®å¤é«˜å±å’Œä¸¥é‡æ¼æ´
              npm audit fix --audit-level=high || echo "æ ¹é¡¹ç›®é«˜å±ä¿®å¤å®Œæˆ"

              cd backend
              npm audit fix --audit-level=high || echo "åç«¯é«˜å±ä¿®å¤å®Œæˆ"
              cd ..

              cd frontend
              npm audit fix --audit-level=high || echo "å‰ç«¯é«˜å±ä¿®å¤å®Œæˆ"
              cd ..

              FIX_SUCCESS=true
              ;;

            *)
              echo "âš ï¸  ä¿®å¤ç­–ç•¥ä¸º ${{ needs.security-scan.outputs.fix_strategy }}ï¼Œè·³è¿‡è‡ªåŠ¨ä¿®å¤"
              ;;
          esac

          echo "FIX_SUCCESS=$FIX_SUCCESS" >> $GITHUB_ENV

      - name: Verify Fixes
        id: verify
        if: env.FIX_SUCCESS == 'true'
        run: |
          echo "=== éªŒè¯ä¿®å¤æ•ˆæœ ==="

          VERIFICATION_SUCCESS=true

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if ! git diff --quiet; then
            echo "âœ… æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            git status --porcelain

            # å°è¯•å®‰è£…ä¾èµ–éªŒè¯
            echo "ğŸ“¦ éªŒè¯ä¾èµ–å®‰è£…..."
            npm install || { echo "âŒ æ ¹é¡¹ç›®ä¾èµ–å®‰è£…å¤±è´¥"; VERIFICATION_SUCCESS=false; }

            cd backend
            npm install || { echo "âŒ åç«¯ä¾èµ–å®‰è£…å¤±è´¥"; VERIFICATION_SUCCESS=false; }
            cd ..

            cd frontend
            npm install --legacy-peer-deps || { echo "âŒ å‰ç«¯ä¾èµ–å®‰è£…å¤±è´¥"; VERIFICATION_SUCCESS=false; }
            cd ..

            # è¿è¡ŒåŸºæœ¬æ„å»ºæµ‹è¯•
            if [ "$VERIFICATION_SUCCESS" = "true" ]; then
              echo "ğŸ”¨ éªŒè¯æ„å»º..."

              # æ„å»ºåç«¯
              cd backend
              npm run build || { echo "âŒ åç«¯æ„å»ºå¤±è´¥"; VERIFICATION_SUCCESS=false; }
              cd ..

              # æ„å»ºå‰ç«¯
              if [ "$VERIFICATION_SUCCESS" = "true" ]; then
                cd frontend
                npm run build || { echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥"; VERIFICATION_SUCCESS=false; }
                cd ..
              fi
            fi

            # é‡æ–°æ£€æŸ¥å®‰å…¨æ¼æ´
            if [ "$VERIFICATION_SUCCESS" = "true" ]; then
              echo "ğŸ” é‡æ–°æ£€æŸ¥å®‰å…¨çŠ¶æ€..."
              npm audit --audit-level=moderate || echo "ä»æœ‰ä¸­ç­‰çº§åˆ«æ¼æ´"
            fi

          else
            echo "âš ï¸  æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå¯èƒ½ä¿®å¤æœªç”Ÿæ•ˆ"
            VERIFICATION_SUCCESS=false
          fi

          echo "VERIFICATION_SUCCESS=$VERIFICATION_SUCCESS" >> $GITHUB_ENV

      - name: Create Security Fix PR
        if: env.FIX_SUCCESS == 'true' && env.VERIFICATION_SUCCESS == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');

            try {
              // è¯»å–ä¿®å¤å‰åçš„å®‰å…¨çŠ¶æ€å¯¹æ¯”
              let beforeScan = {};
              let afterScanSummary = "é‡æ–°æ‰«æä¸­...";

              try {
                beforeScan = JSON.parse(fs.readFileSync('security-reports/consolidated-audit.json', 'utf8'));
              } catch (e) {
                console.log('æ— æ³•è¯»å–ä¿®å¤å‰æ‰«æç»“æœ');
              }

              // æäº¤å˜æ›´
              execSync('git add -A');
              execSync(`git commit -m "ğŸ›¡ï¸ è‡ªåŠ¨å®‰å…¨æ¼æ´ä¿®å¤

              - ä¿®å¤ç­–ç•¥: ${{ needs.security-scan.outputs.fix_strategy }}
              - ä¿®å¤å‰æ¼æ´æ•°: ${{ needs.security-scan.outputs.vulnerabilities_found }}
              - ä¿®å¤æ—¶é—´: ${new Date().toISOString()}
              - è‡ªåŠ¨åŒ–æµç¨‹: security-autofix.yml

              è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹PRæè¿°å’Œå®‰å…¨æŠ¥å‘Šã€‚"`);

              execSync(`git push origin ${process.env.BRANCH_NAME}`);

              // åˆ›å»ºPR
              const prResponse = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ›¡ï¸ è‡ªåŠ¨å®‰å…¨æ¼æ´ä¿®å¤ - ${new Date().toISOString().split('T')[0]}`,
                head: process.env.BRANCH_NAME,
                base: 'master',
                body: `## ğŸ›¡ï¸ è‡ªåŠ¨å®‰å…¨æ¼æ´ä¿®å¤æŠ¥å‘Š

                æœ¬PRç”±å®‰å…¨è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿç”Ÿæˆï¼Œä¿®å¤äº†æ£€æµ‹åˆ°çš„å®‰å…¨æ¼æ´ã€‚

                ### ğŸ“Š ä¿®å¤æ¦‚å†µ
                - **ä¿®å¤å‰æ¼æ´æ€»æ•°**: ${{ needs.security-scan.outputs.vulnerabilities_found }}
                - **ä¿®å¤ç­–ç•¥**: ${{ needs.security-scan.outputs.fix_strategy }}
                - **ä¿®å¤æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
                - **è§¦å‘æ–¹å¼**: ${context.eventName === 'schedule' ? 'å®šæ—¶æ‰«æ' : 'æ‰‹åŠ¨è§¦å‘'}

                ### ğŸ” ä¿®å¤è¯¦æƒ…
                ${beforeScan.metadata ? `
                **ä¿®å¤å‰æ¼æ´åˆ†å¸ƒ**:
                - ä¸¥é‡ (Critical): ${beforeScan.metadata.vulnerabilities.critical || 0}
                - é«˜å± (High): ${beforeScan.metadata.vulnerabilities.high || 0}
                - ä¸­å± (Moderate): ${beforeScan.metadata.vulnerabilities.moderate || 0}
                - ä½å± (Low): ${beforeScan.metadata.vulnerabilities.low || 0}
                ` : ''}

                ### âœ… éªŒè¯ç»“æœ
                - âœ… ä¾èµ–å®‰è£…éªŒè¯é€šè¿‡
                - âœ… åç«¯æ„å»ºéªŒè¯é€šè¿‡
                - âœ… å‰ç«¯æ„å»ºéªŒè¯é€šè¿‡
                - âœ… åŸºæœ¬åŠŸèƒ½éªŒè¯é€šè¿‡

                ### ğŸ“ å˜æ›´æ–‡ä»¶
                ä¸»è¦ä¿®æ”¹äº†ä»¥ä¸‹ä¾èµ–é…ç½®æ–‡ä»¶ï¼š
                - \`package.json\` / \`package-lock.json\`
                - \`backend/package.json\` / \`backend/package-lock.json\`
                - \`frontend/package.json\` / \`frontend/package-lock.json\`

                ### ğŸ”— ç›¸å…³èµ„æº
                - [å®‰å…¨æ‰«ææŠ¥å‘Š](../../actions/runs/${context.runId})
                - [ä¿®å¤ç­–ç•¥è¯¦æƒ…](../../actions/runs/${context.runId}/artifacts)

                ### âš ï¸ æ³¨æ„äº‹é¡¹
                1. è¯·ä»”ç»†reviewä¾èµ–ç‰ˆæœ¬å˜æ›´
                2. å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åº”ç”¨åŠŸèƒ½
                3. å¦‚æœ‰é—®é¢˜å¯å¿«é€Ÿå›æ»šæ­¤PR
                4. åˆå¹¶åå»ºè®®è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

                ### ğŸš€ å»ºè®®æ“ä½œ
                - [ ] Reviewä¾èµ–å˜æ›´æ˜¯å¦åˆç†
                - [ ] åœ¨stagingç¯å¢ƒæµ‹è¯•åº”ç”¨åŠŸèƒ½
                - [ ] ç¡®è®¤æ— åŠŸèƒ½å›å½’ååˆå¹¶
                - [ ] åˆå¹¶åç›‘æ§ç”Ÿäº§ç¯å¢ƒçŠ¶æ€

                ---

                *æœ¬PRç”± [security-autofix.yml](../../blob/master/.github/workflows/security-autofix.yml) è‡ªåŠ¨ç”Ÿæˆ*
                *å¦‚æœ‰é—®é¢˜è¯·è”ç³» DevOps å›¢é˜Ÿ*`
              });

              console.log(`âœ… PRåˆ›å»ºæˆåŠŸ: ${prResponse.data.html_url}`);

              // æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prResponse.data.number,
                labels: ['security', 'auto-fix', 'high-priority', 'dependencies']
              });

              // è®¾ç½®PRä¸ºdraftå¦‚æœæ˜¯å¼ºåˆ¶ä¿®å¤æ¨¡å¼
              if ('${{ inputs.force_fix }}' === 'true') {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prResponse.data.number,
                  draft: true
                });
                console.log('âš ï¸  å¼ºåˆ¶ä¿®å¤æ¨¡å¼ï¼šPRè®¾ç½®ä¸ºdraftçŠ¶æ€ï¼Œè¯·ä»”ç»†review');
              }

            } catch (error) {
              console.error('åˆ›å»ºPRæ—¶å‡ºé”™:', error.message);

              // å¦‚æœPRåˆ›å»ºå¤±è´¥ï¼Œè‡³å°‘ä¿ç•™åˆ†æ”¯
              console.log(`ä¿®å¤åˆ†æ”¯å·²æ¨é€: ${process.env.BRANCH_NAME}`);
              console.log('è¯·æ‰‹åŠ¨åˆ›å»ºPRæˆ–æ£€æŸ¥ä¿®å¤ç»“æœ');
            }

      - name: Cleanup on Failure
        if: failure() && env.FIX_SUCCESS == 'true'
        run: |
          echo "=== æ¸…ç†å¤±è´¥çš„ä¿®å¤å°è¯• ==="

          # æ¢å¤å¤‡ä»½æ–‡ä»¶
          [ -f package.json.backup ] && mv package.json.backup package.json
          [ -f package-lock.json.backup ] && mv package-lock.json.backup package-lock.json
          [ -f backend/package.json.backup ] && mv backend/package.json.backup backend/package.json
          [ -f backend/package-lock.json.backup ] && mv backend/package-lock.json.backup backend/package-lock.json
          [ -f frontend/package.json.backup ] && mv frontend/package.json.backup frontend/package.json
          [ -f frontend/package-lock.json.backup ] && mv frontend/package-lock.json.backup frontend/package-lock.json

          echo "âœ… å·²æ¢å¤å¤‡ä»½æ–‡ä»¶"

  manual-review-notification:
    needs: security-scan
    if: needs.security-scan.outputs.vulnerabilities_found > 0 && needs.security-scan.outputs.fix_strategy == 'manual_review'
    runs-on: ubuntu-latest

    steps:
      - name: Create Manual Review Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { readFileSync } = require('fs');

            // æŸ¥æ‰¾ç°æœ‰çš„å®‰å…¨å®¡æŸ¥issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security-review',
              state: 'open'
            });

            if (existingIssues.data.length > 0) {
              console.log('å·²å­˜åœ¨å®‰å…¨å®¡æŸ¥issueï¼Œæ›´æ–°ç°æœ‰issue');

              const issue = existingIssues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ğŸ” æ–°çš„å®‰å…¨æ‰«æç»“æœ (${new Date().toLocaleString('zh-CN')})

                å‘ç° **${{ needs.security-scan.outputs.vulnerabilities_found }}** ä¸ªå®‰å…¨æ¼æ´éœ€è¦äººå·¥å®¡æŸ¥ã€‚

                ğŸ“Š **æ‰«æè¯¦æƒ…**:
                - æ‰«ææ—¶é—´: ${new Date().toISOString()}
                - ä¿®å¤ç­–ç•¥: ${{ needs.security-scan.outputs.fix_strategy }}
                - ä¸¥é‡çº§åˆ«é˜ˆå€¼: ${{ env.MAX_SEVERITY }}

                ğŸ”— **æŸ¥çœ‹è¯¦æƒ…**: [å®‰å…¨æ‰«ææŠ¥å‘Š](../../actions/runs/${context.runId})

                è¯·DevOpså›¢é˜Ÿå°½å¿«å¤„ç†ã€‚`
              });

            } else {
              console.log('åˆ›å»ºæ–°çš„å®‰å…¨å®¡æŸ¥issue');

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ›¡ï¸ å®‰å…¨æ¼æ´éœ€è¦äººå·¥å®¡æŸ¥ - ${new Date().toISOString().split('T')[0]}`,
                body: `## ğŸ›¡ï¸ å®‰å…¨æ¼æ´äººå·¥å®¡æŸ¥éœ€æ±‚

                è‡ªåŠ¨å®‰å…¨æ‰«æå‘ç°äº†éœ€è¦äººå·¥å¤„ç†çš„å®‰å…¨æ¼æ´ã€‚

                ### ğŸ“Š æ‰«ææ¦‚å†µ
                - **å‘ç°æ¼æ´æ•°**: ${{ needs.security-scan.outputs.vulnerabilities_found }}
                - **æ‰«ææ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
                - **ä¿®å¤ç­–ç•¥**: ${{ needs.security-scan.outputs.fix_strategy }}
                - **ä¸¥é‡çº§åˆ«é˜ˆå€¼**: ${{ env.MAX_SEVERITY }}
                - **è§¦å‘æ–¹å¼**: ${context.eventName === 'schedule' ? 'å®šæ—¶æ‰«æ' : 'æ‰‹åŠ¨è§¦å‘'}

                ### ğŸ” éœ€è¦äººå·¥å®¡æŸ¥çš„åŸå› 
                ä»¥ä¸‹æƒ…å†µéœ€è¦äººå·¥ä»‹å…¥ï¼š
                - æ¼æ´æ¶‰åŠå…³é”®ä¾èµ–çš„é‡å¤§ç‰ˆæœ¬æ›´æ–°
                - ä¿®å¤å¯èƒ½å½±å“åº”ç”¨æ ¸å¿ƒåŠŸèƒ½
                - è‡ªåŠ¨ä¿®å¤å·¥å…·æ— æ³•å¤„ç†çš„å¤æ‚ä¾èµ–å…³ç³»
                - éœ€è¦ä¸šåŠ¡é€»è¾‘é€‚é…çš„å˜æ›´

                ### ğŸ“ å®¡æŸ¥èµ„æº
                - [å®Œæ•´å®‰å…¨æ‰«ææŠ¥å‘Š](../../actions/runs/${context.runId})
                - [æ¼æ´è¯¦æƒ…å’Œä¿®å¤å»ºè®®](../../actions/runs/${context.runId}/artifacts)
                - [è‡ªåŠ¨ä¿®å¤å·¥ä½œæµ](../../blob/master/.github/workflows/security-autofix.yml)

                ### ğŸ“‹ å®¡æŸ¥æ¸…å•
                - [ ] æŸ¥çœ‹è¯¦ç»†çš„æ¼æ´æŠ¥å‘Š
                - [ ] è¯„ä¼°æ¼æ´å½±å“èŒƒå›´å’Œä¸¥é‡ç¨‹åº¦
                - [ ] åˆ¶å®šåˆé€‚çš„ä¿®å¤ç­–ç•¥
                - [ ] åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ä¿®å¤æ–¹æ¡ˆ
                - [ ] å®æ–½ä¿®å¤å¹¶éªŒè¯æ•ˆæœ
                - [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œæµç¨‹

                ### âš¡ å»ºè®®æ“ä½œ
                1. **é«˜ä¼˜å…ˆçº§å¤„ç†**: ç‰¹åˆ«å…³æ³¨Criticalå’ŒHighçº§åˆ«æ¼æ´
                2. **æµ‹è¯•ç¯å¢ƒéªŒè¯**: åœ¨stagingç¯å¢ƒå……åˆ†æµ‹è¯•ä¿®å¤æ•ˆæœ
                3. **æ¸è¿›å¼ä¿®å¤**: å¯ä»¥åˆ†æ‰¹æ¬¡ä¿®å¤ï¼Œä¼˜å…ˆå¤„ç†é«˜å±æ¼æ´
                4. **ç›‘æ§éƒ¨ç½²**: ä¿®å¤ååŠ å¼ºç”Ÿäº§ç¯å¢ƒç›‘æ§

                ### ğŸ”„ åç»­è‡ªåŠ¨åŒ–
                å®Œæˆäººå·¥ä¿®å¤åï¼Œå¯ä»¥è€ƒè™‘ï¼š
                - æ›´æ–°è‡ªåŠ¨ä¿®å¤è§„åˆ™ä»¥å¤„ç†ç±»ä¼¼é—®é¢˜
                - è°ƒæ•´ä¾èµ–ç®¡ç†ç­–ç•¥
                - å®Œå–„å®‰å…¨æ‰«æå’Œä¿®å¤æµç¨‹

                ---

                **åˆ†é…ç»™**: DevOpså›¢é˜Ÿ
                **ä¼˜å…ˆçº§**: é«˜
                **é¢„ä¼°æ—¶é—´**: 2-4å°æ—¶

                *æœ¬issueç”± [security-autofix.yml](../../blob/master/.github/workflows/security-autofix.yml) è‡ªåŠ¨åˆ›å»º*`,
                labels: ['security-review', 'high-priority', 'manual-intervention', 'devops'],
                assignees: [] // å¯ä»¥åœ¨è¿™é‡ŒæŒ‡å®šå…·ä½“çš„å®¡æŸ¥äººå‘˜
              });
            }

  cleanup:
    needs: [security-scan, automated-fix, manual-review-notification]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Workflow Summary
        run: |
          echo "=== å®‰å…¨è‡ªåŠ¨ä¿®å¤å·¥ä½œæµå®Œæˆ ==="
          echo "æ‰«æç»“æœ: ${{ needs.security-scan.outputs.vulnerabilities_found }} ä¸ªæ¼æ´"
          echo "ä¿®å¤ç­–ç•¥: ${{ needs.security-scan.outputs.fix_strategy }}"
          echo "è‡ªåŠ¨ä¿®å¤çŠ¶æ€: ${{ needs.automated-fix.result }}"
          echo "äººå·¥å®¡æŸ¥é€šçŸ¥: ${{ needs.manual-review-notification.result }}"
          echo ""

          if [ "${{ needs.security-scan.outputs.vulnerabilities_found }}" = "0" ]; then
            echo "ğŸ‰ æ­å–œï¼æœªå‘ç°å®‰å…¨æ¼æ´ï¼Œç³»ç»Ÿå®‰å…¨çŠ¶æ€è‰¯å¥½ã€‚"
          elif [ "${{ needs.automated-fix.result }}" = "success" ]; then
            echo "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆï¼Œè¯·reviewç›¸å…³PRã€‚"
          elif [ "${{ needs.manual-review-notification.result }}" = "success" ]; then
            echo "âš ï¸  å·²åˆ›å»ºäººå·¥å®¡æŸ¥ä»»åŠ¡ï¼Œè¯·åŠæ—¶å¤„ç†ã€‚"
          else
            echo "âŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚"
          fi