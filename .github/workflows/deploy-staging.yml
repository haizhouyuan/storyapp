name: Deploy to Staging on CI Success

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]  # å¯¹åº”ci.ymlçš„nameï¼Œç¡®ä¿è§¦å‘åŒ¹é…
    types: [completed]

jobs:
  deploy-staging:
    # åªåœ¨CIæˆåŠŸä¸”æ¥è‡ªPRæ—¶éƒ¨ç½²
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'pull_request'
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      deployments: write
      pull-requests: write
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout PR commit
        uses: actions/checkout@v4
        with:
          # ç­¾å‡ºè§¦å‘CIçš„é‚£æ¬¡æäº¤
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci --legacy-peer-deps

      - name: Build application
        run: |
          npm run build:shared
          npm run build:backend
          npm run build:frontend

      - name: Download build artifacts (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          run-id: ${{ github.event.workflow_run.id }}
          path: ./artifacts

      - name: Prepare deployment environment
        id: prepare
        run: |
          # ç”Ÿæˆéƒ¨ç½²åˆ†æ”¯åç§°ï¼ˆç”¨äºéš”ç¦»ä¸åŒPRçš„æµ‹è¯•ç¯å¢ƒï¼‰
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          DEPLOY_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | cut -c1-50)
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "deploy_branch=$DEPLOY_BRANCH" >> $GITHUB_OUTPUT
          echo "deploy_url=http://localhost:5001" >> $GITHUB_OUTPUT

      - name: Deploy to staging environment
        id: deploy
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY || 'sk-test-dummy' }}
          DEPLOY_BRANCH: ${{ steps.prepare.outputs.deploy_branch }}
        run: |
          # æœ¬åœ°å®¹å™¨åŒ–éƒ¨ç½² - é¿å…å¤–éƒ¨æœåŠ¡å™¨ä¾èµ–
          echo "ğŸš€ å¼€å§‹æœ¬åœ°å®¹å™¨åŒ–éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
          
          # åˆ›å»ºéƒ¨ç½²ç”¨çš„docker-composeé…ç½®
          cat > docker-compose.staging.yml << EOF
          version: '3.8'
          services:
            mongo:
              image: mongo:6.0
              environment:
                MONGO_INITDB_ROOT_USERNAME: root
                MONGO_INITDB_ROOT_PASSWORD: staging123
              ports:
                - "27017:27017"
              volumes:
                - mongo_data:/data/db
              healthcheck:
                test: echo 'db.runCommand("ping").ok' | mongosh --quiet
                interval: 30s
                timeout: 10s
                retries: 3
            
            app:
              build: .
              environment:
                NODE_ENV: staging
                PORT: 5001
                MONGODB_URI: mongodb://root:staging123@mongo:27017/storyapp?authSource=admin
                DEEPSEEK_API_KEY: $DEEPSEEK_API_KEY
              ports:
                - "5001:5001"
              depends_on:
                mongo:
                  condition: service_healthy
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:5001/healthz"]
                interval: 30s
                timeout: 10s
                retries: 3
          
          volumes:
            mongo_data:
          EOF
          
          # æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
          docker compose -f docker-compose.staging.yml up -d --build
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          timeout 120 bash -c 'until curl -f http://localhost:5001/healthz >/dev/null 2>&1; do sleep 5; done'
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "url=${{ steps.prepare.outputs.deploy_url }}" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ”— æœ¬åœ°æµ‹è¯•ç¯å¢ƒ: http://localhost:5001"

      - name: Run deployment verification tests
        if: steps.deploy.outputs.status == 'success'
        run: |
          echo "ğŸ§ª è¿è¡Œéƒ¨ç½²éªŒè¯æµ‹è¯•..."
          
          # åŸºç¡€å¥åº·æ£€æŸ¥
          curl -f http://localhost:5001/healthz || exit 1
          
          # APIæ¥å£æµ‹è¯•
          curl -f http://localhost:5001/api/health || exit 1
          
          # æ•°æ®åº“è¿æ¥æµ‹è¯•
          curl -X POST http://localhost:5001/api/generate-story \
            -H "Content-Type: application/json" \
            -d '{"topic":"æµ‹è¯•æ•…äº‹","maxChoices":3}' || exit 1
          
          echo "âœ… éƒ¨ç½²éªŒè¯æµ‹è¯•é€šè¿‡"

      - name: Comment deployment status on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: ${{ steps.prepare.outputs.pr_number }}
            });
            
            const deployStatus = '${{ steps.deploy.outputs.status }}';
            const deployUrl = '${{ steps.deploy.outputs.deploy_url }}';
            const branchName = '${{ steps.prepare.outputs.branch_name }}';
            
            let statusEmoji = 'âœ…';
            let statusMessage = 'éƒ¨ç½²æˆåŠŸ';
            let deploymentInfo = `
            ğŸ”— **æµ‹è¯•ç¯å¢ƒ**: [${deployUrl}](${deployUrl})
            ğŸ“‹ **åˆ†æ”¯**: \`${branchName}\`
            ğŸ¯ **ç¯å¢ƒ**: staging
            
            ### ğŸ§ª æµ‹è¯•æ–¹æ³•
            \`\`\`bash
            # APIå¥åº·æ£€æŸ¥
            curl ${deployUrl}/healthz
            
            # æ•…äº‹ç”Ÿæˆæµ‹è¯•
            curl -X POST ${deployUrl}/api/generate-story \\
              -H "Content-Type: application/json" \\
              -d '{"topic":"æµ‹è¯•æ•…äº‹","maxChoices":3}'
            \`\`\`
            `;
            
            if (deployStatus !== 'success') {
              statusEmoji = 'âŒ';
              statusMessage = 'éƒ¨ç½²å¤±è´¥';
              deploymentInfo = `
              âš ï¸ **é”™è¯¯**: éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—
              ğŸ“‹ **åˆ†æ”¯**: \`${branchName}\`
              ğŸ¯ **ç¯å¢ƒ**: staging
              `;
            }
            
            const comment = `### ${statusEmoji} è‡ªåŠ¨éƒ¨ç½² - ${statusMessage}
            
            ${deploymentInfo}
            
            ### ğŸ“‹ éƒ¨ç½²ä¿¡æ¯
            - **æäº¤**: ${context.sha.substring(0, 7)}
            - **å·¥ä½œæµ**: [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **æ—¶é—´**: ${new Date().toISOString()}
            
            ---
            *ğŸ¤– ç”±è‡ªåŠ¨éƒ¨ç½²ç³»ç»Ÿç”Ÿæˆ*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.prepare.outputs.pr_number }},
              body: comment
            });

      - name: Update deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deployStatus = '${{ steps.deploy.outputs.status }}';
            const state = deployStatus === 'success' ? 'success' : 'failure';
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: state,
              target_url: '${{ steps.prepare.outputs.deploy_url }}',
              description: `Staging deployment ${state}`,
              environment: 'staging'
            });

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "ğŸ§¹ æ¸…ç†å¤±è´¥çš„éƒ¨ç½²..."
          docker compose -f docker-compose.staging.yml down -v || true
          echo "æ¸…ç†å®Œæˆ"
