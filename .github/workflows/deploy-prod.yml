name: Deploy to Production (ECS)
on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (e.g., sha-xxxxxxxx)"
        required: true
        default: sha-${{ github.sha }}

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production   # 走环境审批 & 拿环境 secrets
    steps:
      - uses: actions/checkout@v4

      - name: SSH into ECS & deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e
            echo "== Login GHCR =="
            echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            cd /root/projects/storyapp  # 按你的服务器目录修改
            
            echo "== 使用 GHCR compose 方式部署 =="
            export APP_TAG=${{ github.event.inputs.tag }}
            
            # 使用标准化的 GHCR compose 配置
            docker compose -f docker-compose.yml -f docker-compose.ghcr.yml pull
            docker compose -f docker-compose.yml -f docker-compose.ghcr.yml up -d --remove-orphans
            docker image prune -f

            echo "== 健康检查 =="
            sleep 10
            curl -f http://localhost:5001/healthz || echo "❌ 健康检查失败"

            echo "✅ 部署完成 - Tag: ${{ github.event.inputs.tag }}"