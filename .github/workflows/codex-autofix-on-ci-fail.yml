name: Codex Autofix on CI failure

on:
  workflow_run:
    # å¿…é¡»ä¸ä¸» CI workflow çš„ name ä¿æŒä¸€è‡´
    workflows: ["CI/CD Pipeline"]
    types: [completed]

jobs:
  autofix:
    if: >
      ${{ github.event.workflow_run.conclusion == 'failure' &&
          github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 20

    steps:
      - name: Determine PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headBranch = run.head_branch;
            const headSha = run.head_sha;

            // æ ¹æ® head åˆ†æ”¯æŸ¥æ‰¾å¯¹åº”çš„å¼€æ”¾ PR
            const { data: prs } = await github.rest.pulls.list({ owner, repo, head: `${owner}:${headBranch}`, state: 'open' });
            if (!prs || prs.length === 0) {
              core.setFailed(`No open PR found for branch ${headBranch}`);
              return;
            }
            const pr = prs[0];
            core.setOutput('number', pr.number.toString());
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('head_sha', headSha);

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (root)
        run: npm ci

      - name: Build shared/backend/frontend (best effort)
        run: |
          npm run -w shared build || true
          npm run -w backend build || true
          npm run -w frontend build || true

      - name: Install Codex CLI
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        run: npm i -g @openai/codex

      - name: Prepare Codex plan
        id: prepare-plan
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        run: |
          cat > codex-plan.md << 'EOF'
          è¯·é˜…è¯»ä»“åº“æ ¹çš„ AGENTS.mdã€.github/workflowsã€package.json çš„ scriptsï¼Œå¹¶æŒ‰é¡¹ç›®é¢„æœŸæ„å»º/æµ‹è¯•é¡ºåºæ‰§è¡Œï¼š
          1) npm ci
          2) npm run -w shared build ï¼ˆè‹¥å­˜åœ¨ï¼‰
          3) npm run -w backend build
          4) npm run -w frontend build
          5) npm run -w backend test

          å¦‚æœæµ‹è¯•å¤±è´¥ï¼š
          - å®šä½æœ€å°æ ¹å› ï¼Œåšæœ€å°ä¸”èšç„¦çš„ä¿®æ”¹
          - å¿…è¦æ—¶è¡¥å……/ä¿®æ­£æµ‹è¯•ï¼Œç¡®ä¿æµ‹è¯•é€šè¿‡
          - ä¿æŒ TypeScript/ESLint è§„èŒƒï¼Œä¸è¦å¤§èŒƒå›´é‡æ„
          å®Œæˆåç”¨æäº¤ä¿¡æ¯ï¼š"codex: autofix"ã€‚
          EOF

      - name: Run Codex autofix
        id: codex
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          echo "ğŸ”§ Running Codex autofix..."
          codex exec "è¯»å– codex-plan.mdï¼›ä¾æ¬¡æ‰§è¡Œå®‰è£…/æ„å»º/æµ‹è¯•ï¼Œè‹¥å¤±è´¥åˆ™æœ€å°åŒ–ä¿®å¤å¹¶æäº¤ï¼›å®Œæˆåå†æ¬¡éªŒè¯æµ‹è¯•é€šè¿‡ã€‚"

      - name: Fallback lint fixes (if Codex not configured)
        if: ${{ steps.codex.outcome == 'skipped' || steps.codex.outcome == 'failure' }}
        run: |
          echo "ğŸ”§ Applying fallback lint:fix where available..."
          cd backend && npm run lint:fix --if-present || true
          cd ..
          cd frontend && npm run lint:fix --if-present || true
          cd ..

      - name: Commit changes (if any)
        id: commit
        run: |
          if ! git diff --quiet; then
            git config user.email "action@github.com"
            git config user.name "Codex Autofix"
            git add -A
            git commit -m "codex: autofix"
            echo "committed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes back to PR branch
        if: ${{ steps.commit.outputs.committed == 'true' }}
        run: |
          BRANCH="${{ steps.pr.outputs.head_ref }}"
          REPO="${{ github.repository }}"
          if [ -n "${{ secrets.CI_PAT }}" ]; then
            echo "Using CI_PAT to push (will retrigger CI)"
            git push https://x-access-token:${{ secrets.CI_PAT }}@github.com/${REPO}.git "$BRANCH"
          else
            echo "CI_PAT not set; pushing with default token (may not retrigger downstream workflows)"
            git push origin "$BRANCH"
          fi

      - name: Post result comment to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const number = parseInt(core.getInput('pr_number')) || parseInt('${{ steps.pr.outputs.number }}');
            const committed = '${{ steps.commit.outputs.committed }}' === 'true';
            const codexOutcome = '${{ steps.codex.outcome || 'skipped' }}';
            const msg = committed
              ? `âœ… Codex Autofix: å·²æäº¤ä¿®å¤å¹¶æ¨é€ï¼ˆCodexæ­¥éª¤ï¼š${codexOutcome}ï¼‰ã€‚CI å°†è‡ªåŠ¨é‡è·‘ã€‚`
              : `ğŸ” Codex Autofix: æ— éœ€ä¿®å¤æˆ–æ— æ³•è‡ªåŠ¨ä¿®å¤ï¼ˆCodexæ­¥éª¤ï¼š${codexOutcome}ï¼‰ã€‚è¯·æŸ¥çœ‹ CI æ—¥å¿—ä¸å˜æ›´ã€‚`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: msg
            });
